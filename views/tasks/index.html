<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskPro Enterprise | 世界级专业任务管理系统</title>
    
    <!-- 引入CSS文件 -->
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/views/tasks/index.css">
    <link rel="stylesheet" href="/plugins/searchHeader/index.css">
    <link rel="stylesheet" href="/views/tasks/plugins/kanbanBoard/index.css">
    <link rel="stylesheet" href="/views/tasks/plugins/enhancedGanttChart/index.css">
    <link rel="stylesheet" href="/views/tasks/plugins/calendarView/index.css">
    <link rel="stylesheet" href="/views/tasks/plugins/matrixView/index.css">

    <!-- 引入字体图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- 元信息 -->
    <meta name="description" content="世界级专业任务管理系统，支持敏捷开发、项目管理、团队协作">
    <meta name="keywords" content="任务管理,项目管理,敏捷开发,团队协作,看板,甘特图,专业版">
    <meta name="author" content="TaskPro Enterprise Team">
    
    <!-- 专业性样式 -->
    <style>
        * { 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            overflow-x: hidden;
        }
        
        input, textarea, [contenteditable], .selectable {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        .global-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #a855f7 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 1;
            visibility: visible;
            transition: all 0.5s ease;
        }
        
        .global-loader.hidden {
            opacity: 0;
            visibility: hidden;
        }
        
        .loader-content {
            text-align: center;
            color: white;
        }
        
        .loader-logo {
            font-size: 3rem;
            margin-bottom: 1rem;
            animation: pulse 2s infinite;
        }
        
        .loader-text {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 2rem;
        }
        
        .loader-progress {
            width: 200px;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            overflow: hidden;
            margin: 0 auto;
        }
        
        .loader-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #fff, rgba(255,255,255,0.8));
            border-radius: 2px;
            animation: loadingBar 3s ease-in-out;
        }
        
        /* 错误显示样式 */
        .initialization-error,
        .startup-error {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9998;
        }
        
        .error-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            text-align: center;
            max-width: 500px;
            width: 90%;
        }
        
        .error-content i {
            font-size: 3rem;
            color: #ef4444;
            margin-bottom: 1rem;
        }
        
        .error-content h3 {
            color: #1f2937;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .error-content p {
            color: #6b7280;
            font-size: 1rem;
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }
        
        .error-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 1rem;
        }
        
        .retry-btn,
        .details-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .retry-btn {
            background: #3b82f6;
            color: white;
        }
        
        .retry-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        
        .details-btn {
            background: #f3f4f6;
            color: #374151;
        }
        
        .details-btn:hover {
            background: #e5e7eb;
        }
        
        .error-details {
            margin-top: 1rem;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .error-details pre {
            font-size: 0.75rem;
            color: #6b7280;
            margin: 0;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes loadingBar {
            0% { width: 0%; }
            100% { width: 100%; }
        }
    </style>
</head>
<body>
    <!-- 全局加载器 -->
    <div id="globalLoader" class="global-loader">
        <div class="loader-content">
            <div class="loader-logo">
                <i class="fas fa-layer-group"></i>
            </div>
            <div class="loader-text">TaskPro Enterprise</div>
            <div class="loader-progress">
                <div class="loader-bar"></div>
            </div>
        </div>
    </div>

    <div id="app">
        <!-- 主要内容区域 -->
        <div class="main-layout">
            <!-- 主内容区 -->
        <main class="main-content" role="main">
                <!-- 高级工具栏 - 重构为与首页header-row一致的布局 -->
                <div class="advanced-toolbar">
                    <div class="toolbar-row">
                        <div class="toolbar-left">
                            <!-- 快速搜索 -->
                            <div class="search-box" role="search" aria-label="任务搜索">
                                <span class="search-logo" aria-hidden="true" @click="goToHome">
                                    <i class="fas fa-brain" aria-label="AI大脑图标"></i>
                                </span>
                                <div class="search-input-wrapper">
                                    <label for="taskSearchInput" class="visually-hidden">任务搜索输入框</label>
                                    <textarea 
                                        id="taskSearchInput" 
                                        v-model="searchQuery"
                                        @input="handleQuickSearch"
                                        placeholder="搜索任务内容，支持标题、描述、输入输出、步骤等..." 
                                        rows="1" 
                                        maxlength="2000"
                                        aria-label="任务搜索输入框"
                                        autocomplete="off"
                                        spellcheck="false"
                                        class="search-input"></textarea>
                                    
                                    <!-- 清除搜索按钮 -->
                                    <div class="search-clear" v-if="searchQuery">
                                        <button 
                                            @click="clearSearch"
                                            class="clear-search-btn"
                                            type="button"
                                            title="清除搜索"
                                            aria-label="清除搜索内容"
                                        >
                                            <i class="fas fa-times" aria-hidden="true"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="toolbar-right">
                          <!-- 视图选项 -->
                          <div class="view-options">
                              <button @click="toggleFullscreen" class="option-btn">
                                  <i class="fas fa-expand"></i>
                                  <span>全屏</span>
                              </button>
                          </div>
                            <!-- 视图切换 - 重构为与首页cascader一致的交互 -->
                            <div class="view-switcher">
                                <div class="view-cascader">
                                    <button v-for="view in availableViews" :key="view.key"
                                            @click="setCurrentView(view.key)"
                                            :class="['view-btn', { active: currentView === view.key }]"
                                            :title="view.description"
                                            :aria-label="`切换到${view.name}视图`">
                                        <i :class="view.icon" aria-hidden="true"></i>
                                        <span>{{ view.name }}</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 批量操作 -->
                            <div v-if="selectedTasks.length > 0" class="batch-actions">
                                <span class="selected-count">已选择 {{ selectedTasks.length }} 项</span>
                                <button @click="batchUpdateStatus" class="batch-btn" title="批量更新状态">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button @click="batchDelete" class="batch-btn danger" title="批量删除">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            
                            <!-- 下载功能按钮 -->
                            <div class="download-section">
                                <button 
                                    type="button"
                                    class="option-btn"
                                    @click="handleDownloadTasks"
                                    :disabled="loading || !filteredTasks.length"
                                    :title="filteredTasks.length ? `下载 ${filteredTasks.length} 个任务数据` : '没有可下载的任务'">
                                    <i class="fas fa-download" aria-hidden="true"></i>
                                    <span>下载</span>
                                </button>
                            </div>
                            
                            <!-- 下载上传样例按钮 -->
                            <div class="download-sample-section">
                                <button 
                                    type="button"
                                    class="option-btn"
                                    @click="handleDownloadSample"
                                    :disabled="loading"
                                    title="下载上传样例数据，可直接上传使用">
                                    <i class="fas fa-file-code" aria-hidden="true"></i>
                                    <span>样例</span>
                                </button>
                            </div>
                            
                            <!-- 上传功能按钮 -->
                            <div class="upload-section">
                                <button 
                                    type="button"
                                    class="option-btn"
                                    @click="triggerUploadTasks"
                                    :disabled="loading"
                                    title="上传任务数据文件">
                                    <i class="fas fa-upload" aria-hidden="true"></i>
                                    <span>上传</span>
                                </button>
                                <input 
                                    id="tasksUploadInput"
                                    ref="uploadInput"
                                    type="file" 
                                    accept=".zip,.json"
                                    @change="handleUploadTasks"
                                    class="hidden" 
                                    aria-label="上传任务数据文件">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 任务视图内容区 -->
                <div class="content-area">
                    <!-- 任务列表视图 -->
                    <enhanced-task-list
                        v-if="currentView === 'list'"
                        :tasks="filteredTasks"
                    :loading="loading"
                    :error="error"
                        :selected-tasks="selectedTasks"
                        @task-select="handleTaskSelect"
                    @task-click="handleTaskClick"
                        @task-update="handleTaskUpdate"
                        @task-delete="handleTaskDelete"
                        @selection-change="handleSelectionChange"
                    ></enhanced-task-list>
                    
                    <!-- 看板视图 -->
                    <kanban-board
                        v-if="currentView === 'kanban'"
                        :tasks="filteredTasks"
                        @task-move="handleTaskMove"
                        @task-select="handleTaskSelect"
                        @task-create="handleTaskCreate"
                    ></kanban-board>
                    
                    <!-- 甘特图视图 -->
                    <enhanced-gantt-chart
                        v-if="currentView === 'gantt'"
                        :tasks="filteredTasks"
                        @task-update="handleTaskUpdate"
                    ></enhanced-gantt-chart>
                    
                    <!-- 周报视图 -->
                    <weekly-report
                        v-if="currentView === 'weekly'"
                        :tasks="filteredTasks"
                        :current-view="currentView"
                        :get-task-time-data="getTaskTimeData"
                        @task-select="handleTaskSelect"
                    ></weekly-report>
                    
                    <!-- 日报视图 -->
                    <daily-report
                        v-if="currentView === 'daily'"
                        :tasks="filteredTasks"
                        :current-view="currentView"
                        :get-task-time-data="getTaskTimeData"
                        @task-select="handleTaskSelect"
                    ></daily-report>
                    <!-- 矩阵视图 -->
                    <matrix-view
                        v-if="currentView === 'matrix'"
                        :tasks="filteredTasks"
                        @task-select="handleTaskSelect"
                    ></matrix-view>
                </div>
        </main>
    </div>

        
    </div>

    <!-- 引入Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- 引入工具类（使用ES6模块） -->
    <script type="module" src="/config.js"></script>
    <script src="/utils/index.js"></script>
    <script type="module" src="/utils/log.js"></script>
    <script type="module" src="/utils/baseView.js"></script>
    <script type="module" src="/utils/loading.js"></script>
    <script type="module" src="/utils/message.js"></script>
    
    <!-- 引入API模块（使用ES6模块） -->
    <script type="module" src="/apis/index.js"></script>
    <script type="module" src="/apis/helper/checkStatus.js"></script>
    <script type="module" src="/apis/helper/requestHelper.js"></script>
    <script type="module" src="/apis/modules/crud.js"></script>
    
    <!-- 引入数据（必须在其他脚本之前加载） -->
    <script src="/views/tasks/data/mockData.js"></script>
    
    <!-- 引入hooks逻辑 -->
    <script src="/views/tasks/hooks/store.js"></script>
    <script src="/views/tasks/hooks/useComputed.js"></script>
    <script src="/views/tasks/hooks/useMethods.js"></script>
    
    <!-- 引入新组件（优先兼容现有组件） -->
    <script src="/views/tasks/plugins/enhancedTaskList/index.js"></script>
    <script src="/views/tasks/plugins/kanbanBoard/index.js"></script>
    <script src="/views/tasks/plugins/enhancedGanttChart/index.js"></script>

    <script src="/views/tasks/plugins/matrixView/index.js"></script>
    
    <!-- 兼容现有组件 -->
    <script src="/views/tasks/plugins/taskList/index.js"></script>
    <script src="/views/tasks/plugins/ganttChart/index.js"></script>
    <script src="/views/tasks/plugins/weeklyReport/index.js"></script>
    <script src="/views/tasks/plugins/dailyReport/index.js"></script>
    
    <!-- 引入页面逻辑 -->
    <script src="/views/tasks/index.js"></script>
    
    <!-- 工具函数安全检查脚本 -->
    <script>
        // 确保必要的工具函数存在
        function ensureUtilityFunctions() {
            // 检查并创建loading函数的fallback
            if (!window.showGlobalLoading) {
                console.warn('[TaskPro] showGlobalLoading未定义，创建fallback实现');
                window.showGlobalLoading = function(message) {
                    console.log('[Loading]', message || '加载中...');
                };
            }
            
            if (!window.hideGlobalLoading) {
                console.warn('[TaskPro] hideGlobalLoading未定义，创建fallback实现');
                window.hideGlobalLoading = function() {
                    console.log('[Loading] 加载完成');
                };
            }
            
            // 检查并创建message函数的fallback
            if (!window.showSuccess) {
                console.warn('[TaskPro] showSuccess未定义，创建fallback实现');
                window.showSuccess = function(message) {
                    console.log('[Success]', message);
                    // 简单的成功提示
                    if (typeof alert !== 'undefined') {
                        alert('成功: ' + message);
                    }
                };
            }
            
            if (!window.showError) {
                console.warn('[TaskPro] showError未定义，创建fallback实现');
                window.showError = function(message) {
                    console.error('[Error]', message);
                    // 简单的错误提示
                    if (typeof alert !== 'undefined') {
                        alert('错误: ' + message);
                    }
                };
            }
        }
        
        // 在DOM加载完成后立即检查工具函数
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[TaskPro] 检查工具函数...');
            ensureUtilityFunctions();
        });
        
        // 组件注册脚本
        function ensureComponentsLoaded() {
            const requiredComponents = [
                'EnhancedTaskList',
                'KanbanBoard', 
                'EnhancedGanttChart',
                'WeeklyReport',
                'DailyReport',
                'MatrixView'
            ];
            
            console.log('[TaskPro] 检查组件加载状态...');
            console.log('[TaskPro] 当前全局组件:', Object.keys(window).filter(key => 
                requiredComponents.includes(key)
            ));
            
            const missingComponents = requiredComponents.filter(name => !window[name]);
            
            if (missingComponents.length > 0) {
                console.warn('[TaskPro] 等待组件加载:', missingComponents);
                setTimeout(ensureComponentsLoaded, 100);
                return;
            }
            
            console.log('[TaskPro] 所有组件已加载，可以启动应用');
            
            // 触发组件加载完成事件
            window.dispatchEvent(new CustomEvent('TaskProComponentsReady'));
        }
        
        // DOM内容加载完成后立即检查组件状态
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[TaskPro] DOM内容加载完成，开始检查组件状态');
            // 延迟一点时间确保脚本执行完成
            setTimeout(ensureComponentsLoaded, 50);
        });
        
        // 监听KanbanBoard组件加载事件
        window.addEventListener('KanbanBoardLoaded', function(event) {
            console.log('[TaskPro] 收到KanbanBoard组件加载事件:', event.detail);
        });
        
        // 页面加载完成后的统一处理
        window.addEventListener('load', function() {
            console.log('[TaskPro] 页面加载完成，再次检查组件状态');
            // 检查组件加载状态
            ensureComponentsLoaded();
            
            // 隐藏加载器
            setTimeout(() => {
                const loader = document.getElementById('globalLoader');
                if (loader) {
                    loader.classList.add('hidden');
                    setTimeout(() => {
                        loader.style.display = 'none';
                    }, 500);
                }
            }, 1000);
        });
        
        // 立即检查一次组件状态（作为备用）
        console.log('[TaskPro] 立即检查组件状态...');
        setTimeout(ensureComponentsLoaded, 100);
    </script>
    
    <!-- 快捷键支持 -->
    <script>
        // 快捷键支持
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                const searchInput = document.querySelector('.global-search-input');
                if (searchInput) {
                    searchInput.focus();
                }
            }
            
            if (e.key === 'F1') {
                e.preventDefault();
            }
            
            if (e.key >= '1' && e.key <= '7' && !e.ctrlKey && !e.altKey && !e.metaKey) {
                e.preventDefault();
            }
        });
        
        // 禁用右键菜单，增强专业性
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });
    </script>
</body>
</html> 



