<!-- 代码查看组件模板 -->
<section class="code-view-container" role="main" aria-label="代码查看器">
    <!-- 加载状态 -->
    <div v-if="loading" class="loading-container" role="status" aria-live="polite">
        <div class="loading-spinner" aria-hidden="true"></div>
        <div class="loading-text">正在加载代码...</div>
    </div>

    <!-- 错误状态 -->
    <div v-else-if="error" class="error-container" role="alert">
        <div class="error-icon" aria-hidden="true">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="error-message">{{ error }}</div>
    </div>

    <!-- 代码内容 -->
    <div v-else-if="file" class="code-content" ref="codeContent">
        <div class="code-header">
            <div class="file-name" :title="file.path || file.name">
                <i class="fas fa-file-code"></i>
                {{ file.path || file.name }}
            </div>
            <div class="code-actions">
                <button v-if="!isEditing" @click="startEdit" class="action-button edit-button" title="编辑">
                    <i class="fas fa-edit"></i>
                    <span class="btn-text">编辑</span>
                </button>
                <template v-else>
                    <button @click="saveEdit" :disabled="saving || !canSaveEdit" class="action-button save-button" title="保存 (⌘/Ctrl+S)">
                        <i class="fas" :class="saving ? 'fa-spinner fa-spin' : 'fa-save'"></i>
                        <span class="btn-text">保存</span>
                    </button>
                    <button @click="cancelEdit" :disabled="saving" class="action-button cancel-button" title="取消 (Esc)">
                        <i class="fas fa-times"></i>
                        <span class="btn-text">取消</span>
                    </button>
                </template>
            </div>
        </div>
        <!-- 调试信息 -->
        <div v-if="false" class="debug-info" style="background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; font-size: 12px;">
            <p>调试信息:</p>
            <p>文件: {{ file.name }}</p>
            <p>代码行数: {{ codeLines.length }}</p>
            <p>评论数量: {{ fileComments.length }}</p>
            <p>评论标记行数: {{ Object.keys(commentMarkers).length }}</p>
            <p>有评论标记的行数: {{ Object.keys(lineComments).filter(line => lineComments[line].length > 0).length }}</p>
            <p>加载状态: {{ commentsLoading }}</p>
            <p>错误信息: {{ commentsError }}</p>
        </div>
        <!-- 编辑模式 -->
        <div v-if="isEditing" class="edit-container">
            <textarea 
                class="edit-textarea"
                v-model="editableContent"
                @keydown="handleEditorKeydown"
                @input="autoResizeEditor"
                ref="editTextarea"
                aria-label="代码编辑器"
                placeholder="在此编辑代码…"
                spellcheck="false"
            ></textarea>
            <div v-if="saveError" class="save-error">
                <i class="fas fa-exclamation-circle"></i> {{ saveError }}
            </div>
        </div>

        <!-- 只读模式 -->
        <pre v-else class="code-block" :class="`language-${languageType}`">
            <code 
                v-for="(line, index) in codeLines" 
                :key="index + 1"
                :class="['code-line', highlightedLines.includes(index + 1) ? 'highlight' : '']"
                :data-line="index + 1"
                :title="`行号: ${index + 1}, 是否高亮: ${highlightedLines.includes(index + 1)}`"
            >
                <span class="line-number">{{ index + 1 }}</span>
                <span class="line-content" v-html="escapeHtml(line)"></span>
                
                <!-- 评论标记 -->
                <div v-if="lineComments[index + 1] && lineComments[index + 1].length > 0" class="comment-markers">
                    <div 
                        v-for="(comment, commentIndex) in lineComments[index + 1]" 
                        :key="comment.key || commentIndex"
                        class="comment-marker"
                        :class="getCommentStatusClass(comment.status)"
                        :data-comment-key="comment.key"
                        @click="showCommentDetail(comment, $event)"
                        @mouseenter="handleCommentMarkerMouseEvents(comment, $event)"
                        @mouseleave="handleCommentMarkerMouseEvents(comment, $event)"
                        :title="`${comment.author || '匿名用户'} - ${formatTime(comment.timestamp)}`"
                        role="button"
                        tabindex="0"
                    >
                        <i class="fas fa-comment"></i>
                        <span class="comment-count" v-if="lineComments[index + 1].length > 1">
                            {{ lineComments[index + 1].length }}
                        </span>
                    </div>
                </div>
            </code>
        </pre>
        <!-- 划词评论按钮和弹窗容器 -->
        <div id="comment-action-container"></div>
        
        <!-- 评论详情弹窗 -->
        <div 
            v-if="showCommentDetailPopup && currentCommentDetail" 
            class="comment-detail-popup"
            role="dialog"
            aria-label="评论详情"
        >
            <div class="comment-detail-header">
                <div class="comment-author-info">
                    <div class="comment-author-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="comment-author-details">
                        <div class="author-name-row">
                            <span class="comment-author">{{ currentCommentDetail.author }}</span>
                            <!-- 评论状态 - 移到作者名旁边 -->
                            <span v-if="currentCommentDetail.status" class="status-badge-inline" :class="getCommentStatusClass(currentCommentDetail.status)">
                                {{ getCommentStatusLabel(currentCommentDetail.status) }}
                            </span>
                        </div>
                        <time class="comment-time" :datetime="currentCommentDetail.timestamp">
                            {{ formatTime(currentCommentDetail.timestamp) }}
                        </time>
                    </div>
                </div>
                <button 
                    @click="hideCommentDetail"
                    class="close-button"
                    title="关闭"
                    aria-label="关闭评论详情"
                >
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="comment-detail-body">
                <!-- 代码位置信息 -->
                <div v-if="currentCommentDetail.rangeInfo" class="comment-location">
                    <i class="fas fa-code"></i>
                    <span class="location-text">
                        第 {{ currentCommentDetail.rangeInfo.startLine }}{{ currentCommentDetail.rangeInfo.endLine !== currentCommentDetail.rangeInfo.startLine ? `-${currentCommentDetail.rangeInfo.endLine}` : '' }} 行
                    </span>
                </div>
                
                <!-- 引用的代码 -->
                <div v-if="currentCommentDetail.text" class="comment-quote">
                    <div class="quote-header">
                        <i class="fas fa-quote-left"></i>
                        <span>引用代码</span>
                    </div>
                    <pre class="quote-code" @click="highlightCode(currentCommentDetail)">
                        <code>{{ currentCommentDetail.text }}</code>
                    </pre>
                </div>
                
                <!-- 评论内容（Markdown渲染，含图片） -->
                <div class="comment-content md-preview-body" v-html="currentCommentDetailHtml"></div>
                
                <!-- 改进代码 -->
                <div v-if="currentCommentDetail.improvementText" class="comment-improvement">
                    <div class="improvement-header">
                        <i class="fas fa-magic"></i>
                        <span>改进代码</span>
                    </div>
                    <pre class="improvement-code">
                        <code>{{ currentCommentDetail.improvementText }}</code>
                    </pre>
                </div>
                
                <!-- 评论操作按钮 -->
                <div class="comment-detail-actions">
                    <button 
                        v-if="currentCommentDetail.status === 'pending'"
                        @click="resolveCommentDetail(currentCommentDetail.key)"
                        class="action-button resolve-button"
                        title="标记为已解决"
                    >
                        <i class="fas fa-check"></i>
                        解决
                    </button>
                    
                    <button 
                        v-if="currentCommentDetail.status === 'resolved'"
                        @click="reopenCommentDetail(currentCommentDetail.key)"
                        class="action-button reopen-button"
                        title="重新打开"
                    >
                        <i class="fas fa-undo"></i>
                        重开
                    </button>
                    
                    <button 
                        @click="deleteCommentDetail(currentCommentDetail.key)"
                        class="action-button delete-button"
                        title="删除评论"
                    >
                        <i class="fas fa-trash"></i>
                        删除
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 未选评论者时的手动评论弹框 -->
        <div 
            v-if="showManualImprovementModal" 
            class="manual-improvement-modal" 
            role="dialog" 
            aria-label="手动填写评论内容"
        >
            <div class="manual-improvement-content">
                <div class="manual-improvement-header">
                    <h3 class="manual-improvement-title">填写评论内容</h3>
                    <button class="close-btn" @click="closeManualImprovementModal" title="关闭" aria-label="关闭">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="manual-improvement-body">
                    <div class="md-input-preview" :class="{ 'preview-collapsed': manualPreviewCollapsed }">
                        <div class="md-input">
                            <div class="md-toolbar" role="toolbar" aria-label="Markdown工具栏">
                                <button class="md-btn" title="粗体" @click="insertMarkdown('bold')"><i class="fas fa-bold"></i></button>
                                <button class="md-btn" title="斜体" @click="insertMarkdown('italic')"><i class="fas fa-italic"></i></button>
                                <button class="md-btn" title="行内代码" @click="insertMarkdown('code')"><i class="fas fa-code"></i></button>
                                <button class="md-btn" title="代码块" @click="insertMarkdown('codeblock')"><i class="fas fa-file-code"></i></button>
                                <button class="md-btn" title="无序列表" @click="insertMarkdown('ul')"><i class="fas fa-list-ul"></i></button>
                                <button class="md-btn" title="有序列表" @click="insertMarkdown('ol')"><i class="fas fa-list-ol"></i></button>
                                <button class="md-btn" title="链接" @click="insertMarkdown('link')"><i class="fas fa-link"></i></button>
                                    <button class="md-btn" title="预览" :aria-label="manualPreviewCollapsed ? '展开预览' : '折叠预览'" @click="toggleManualPreviewCollapse"><i class="fas" :class="manualPreviewCollapsed ? 'fa-eye' : 'fa-eye-slash'"></i></button>
                                <span class="md-toolbar-spacer"></span>
                                <span class="md-counter" :title="`最多 ${manualMaxLength} 字`">{{ (manualCommentText || '').length }} / {{ manualMaxLength }}</span>
                            </div>
                            <textarea 
                                class="manual-improvement-input"
                                v-model="manualCommentText" 
                                placeholder="请输入要发布的评论内容，支持Markdown语法"
                                rows="10"
                                ref="manualCommentTextarea"
                                @keydown="handleManualKeydown"
                            ></textarea>
                            <div v-if="manualCommentError" class="manual-improvement-error">
                                <i class="fas fa-exclamation-circle"></i> {{ manualCommentError }}
                            </div>
                        </div>
                        <div class="md-preview" v-show="!manualPreviewCollapsed">
                            <div class="preview-header-row">
                                <span class="preview-title"><i class="fas fa-eye"></i> 预览</span>
                            </div>
                            <div class="md-preview-body" v-html="manualCommentPreviewHtml"></div>
                        </div>
                    </div>
                </div>
                <div class="manual-improvement-actions">
                    <button class="action-button cancel" @click="closeManualImprovementModal">
                        <i class="fas fa-times"></i> 取消
                    </button>
                    <button class="action-button confirm" :disabled="!canSubmitManualComment" @click="submitManualImprovement">
                        <i class="fas" :class="manualSubmitting ? 'fa-spinner fa-spin' : 'fa-paper-plane'"></i> 提交
                    </button>
                </div>
            </div>
        </div>

        <!-- 评论预览弹窗（悬停显示） -->
        <div 
            v-if="showCommentPreviewPopup && currentCommentPreview" 
            class="comment-preview-popup"
            :style="{
                left: commentPreviewPosition.x + 'px',
                top: commentPreviewPosition.y + 'px'
            }"
            role="tooltip"
            aria-label="评论预览"
        >
            <div class="preview-header">
                <div class="preview-author-info">
                    <div class="preview-author-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="preview-author-details">
                        <div class="preview-author-name-row">
                            <span class="preview-author">{{ currentCommentPreview.author }}</span>
                            <!-- 评论状态 - 移到作者名旁边 -->
                            <span v-if="currentCommentPreview.status" class="preview-status-badge-inline" :class="getCommentStatusClass(currentCommentPreview.status)">
                                {{ getCommentStatusLabel(currentCommentPreview.status) }}
                            </span>
                        </div>
                        <time class="preview-time" :datetime="currentCommentPreview.timestamp">
                            {{ formatTime(currentCommentPreview.timestamp) }}
                        </time>
                    </div>
                </div>
            </div>
            
            <div class="preview-body">
                <!-- 评论内容预览（Markdown渲染，含图片） -->
                <div class="preview-content md-preview-body" v-html="currentCommentPreviewHtml"></div>
                
                <!-- 引用的代码预览（如果有） -->
                <div v-if="currentCommentPreview.text" class="preview-quote">
                    <div class="preview-quote-header">
                        <i class="fas fa-quote-left"></i>
                        <span>引用代码</span>
                    </div>
                    <pre class="preview-quote-code">
                        <code>{{ currentCommentPreview.text }}</code>
                    </pre>
                </div>
                
                <!-- 改进代码预览（如果有） -->
                <div v-if="currentCommentPreview.improvementText" class="preview-improvement">
                    <div class="preview-improvement-header">
                        <i class="fas fa-magic"></i>
                        <span>改进建议</span>
                    </div>
                    <pre class="preview-improvement-code">
                        <code>{{ currentCommentPreview.improvementText }}</code>
                    </pre>
                </div>
            </div>
            
            <!-- 点击查看详情提示 -->
            <div class="preview-footer">
                <span class="preview-hint">点击查看完整详情</span>
            </div>
        </div>
    </div>

    <!-- 空状态 -->
    <div v-else class="empty-state" role="status">
        <div class="empty-icon" aria-hidden="true">
            <i class="fas fa-file-code"></i>
        </div>
        <div class="empty-title">请选择文件</div>
        <div class="empty-subtitle">从左侧文件树中选择要查看的文件</div>
    </div>
</section>







