<!-- 代码评审评论面板组件模板 -->
<aside class="comment-panel-container" :class="{ 'collapsed': collapsed }" role="complementary" aria-label="代码评审评论面板">
    <!-- 收起/展开按钮 -->
    <div class="comment-panel-toggle" @click="$emit('toggle-collapse')" :title="collapsed ? '展开评论区' : '收起评论区'">
        <i class="fas fa-chevron-right" :class="{ 'rotated': collapsed }"></i>
    </div>
    
    <!-- 全局加载状态 -->
    <div v-if="loading || commentsLoading" class="loading-container" role="status" aria-live="polite">
        <div class="loading-spinner" aria-hidden="true"></div>
        <div class="loading-text">正在加载评论...</div>
    </div>

    <!-- 错误状态 -->
    <div v-else-if="error" class="error-container" role="alert" aria-live="polite">
        <div class="error-icon" aria-hidden="true">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="error-text">{{ error }}</div>
    </div>

    <!-- 评论内容 -->
    <div v-else class="comment-panel-content">
        <!-- 评论者头像选择区域 -->
        <div class="commenter-avatars">
                            <div class="avatars-header">
                    <div class="avatars-title-row">
                        <span class="avatars-title">选择评论者</span>
                        <div class="avatars-actions">
                            <button 
                                @click="openCommenterEditor"
                                class="edit-commenters-btn"
                                :class="{ 'no-commenters': commenters.length === 0 }"
                                :title="commenters.length === 0 ? '添加第一个评论者' : '编辑评论者'"
                                :aria-label="commenters.length === 0 ? '添加第一个评论者' : '编辑评论者'"
                            >
                                <i :class="commenters.length === 0 ? 'fas fa-plus' : 'fas fa-edit'"></i>
                                {{ commenters.length === 0 ? '添加评论者' : '编辑评论者' }}
                            </button>
                        </div>
                    </div>
                <span class="avatars-subtitle">点击头像选择评论者（默认选中第一个，支持多选）</span>
                <span class="avatars-count">共 {{ commenterStats.total }} 位评论者，已选择 {{ commenterStats.selected }} 位</span>
            </div>
            <div v-if="finalCommentersLoading" class="avatars-loading">
                <div class="loading-spinner"></div>
                <span>加载评论者中...</span>
            </div>
            <div v-else-if="finalCommentersError" class="avatars-error">
                <span>{{ finalCommentersError }}</span>
            </div>
            <div v-else-if="finalCommenters.length > 0" class="avatars-container">
                <div 
                    v-for="(commenter, index) in finalCommenters" 
                    :key="commenter.key"
                    class="commenter-avatar"
                    :class="{ 
                        'selected': finalSelectedCommenterIds.includes(commenter.key),
                        'multi-selected': finalSelectedCommenterIds.length > 1 && finalSelectedCommenterIds.includes(commenter.key)
                    }"
                    @click="toggleCommenter(commenter)"
                    @keydown.enter="toggleCommenter(commenter)"
                    @keydown.space="toggleCommenter(commenter)"
                    :title="commenter.name"
                    :aria-label="`选择评论者 ${commenter.name}`"
                    :aria-pressed="finalSelectedCommenterIds.includes(commenter.key)"
                    tabindex="0"
                    role="button"
                >
                    <div class="avatar-image" :style="getCommenterAvatar(commenter)">
                        {{ getCommenterAvatar(commenter).text }}
                    </div>
                    <div class="avatar-name">{{ commenter.name }}</div>
                    <button 
                        @click.stop="editCommenter(commenter)"
                        class="avatar-edit-btn"
                        title="编辑评论者"
                        aria-label="编辑评论者"
                    >
                        <i class="fas fa-pen"></i>
                    </button>
                </div>
                
                <!-- 始终显示的添加评论者按钮 -->
                <div 
                    class="commenter-avatar add-commenter-avatar"
                    @click="addNewCommenter"
                    @keydown.enter="addNewCommenter"
                    @keydown.space="addNewCommenter"
                    title="添加评论者"
                    aria-label="添加评论者"
                    tabindex="0"
                    role="button"
                >
                    <div class="avatar-image add-avatar-image">
                        <i class="fas fa-plus"></i>
                    </div>
                    <div class="avatar-name">添加</div>
                </div>
            </div>
            <div v-else class="avatars-empty">
                <div class="empty-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="empty-title">暂无评论者</div>
                <div class="empty-subtitle">点击下方按钮添加第一个评论者</div>
                <button 
                    @click="addNewCommenter"
                    class="add-commenter-btn"
                    title="添加评论者"
                >
                    <i class="fas fa-plus"></i>
                    添加评论者
                </button>
            </div>
        </div>


        <!-- 评论列表 -->
        <div v-if="renderComments && renderComments.length > 0" class="comment-list" role="list">
            <!-- 调试信息 -->
            <div v-if="false" class="debug-info" style="background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; font-size: 12px;">
                <p>调试信息:</p>
                <p>评论数量: {{ renderComments.length }}</p>
                <p>文件信息: {{ file ? file.name : '无文件' }}</p>
                <p>加载状态: {{ loading }}</p>
                <p>错误信息: {{ error }}</p>
            </div>
            <article 
                v-for="comment in renderComments" 
                :key="comment.key"
                class="comment-item"
                :class="getCommentStatusClass(comment.status)"
                role="listitem"
            >
                <!-- 评论头部 -->
                <div class="comment-header-section">
                    <div class="comment-meta">
                        <div class="comment-author-info">
                            <div class="comment-avatar" :style="getAuthorAvatar(comment.author)">
                                {{ getAuthorAvatar(comment.author).text }}
                            </div>
                            <div class="comment-author-details">
                                <span class="comment-author">{{ comment.author }}</span>
                                <time class="comment-time" :datetime="comment.timestamp">
                                    {{ formatTime(comment.timestamp) }}
                                </time>
                            </div>
                        </div>
                        
                        <!-- 评论类型和状态 -->
                        <div class="comment-badges">
                            <span v-if="comment.type" class="comment-type" :class="`type-${comment.type}`">
                                <i :class="getCommentTypeIcon(comment.type)"></i>
                                {{ getCommentTypeLabel(comment.type) }}
                            </span>
                            <span v-if="comment.status" class="comment-status" :class="`status-${comment.status}`">
                                <i :class="getCommentStatusIcon(comment.status)"></i>
                                {{ getCommentStatusLabel(comment.status) }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- 代码位置信息 -->
                <div v-if="comment.rangeInfo" class="code-location">
                    <div class="location-header">
                        <i class="fas fa-code"></i>
                        <span class="location-text">
                            第 {{ comment.rangeInfo.startLine }}{{ comment.rangeInfo.endLine !== comment.rangeInfo.startLine ? `-${comment.rangeInfo.endLine}` : '' }} 行
                        </span>
                    </div>
                    
                </div>

                <!-- 评论内容 -->
                <div class="comment-body">
                    <div v-if="comment.text" class="comment-quote">
                        <div class="quote-header">
                            <i class="fas fa-quote-left"></i>
                            <span>引用代码</span>
                        </div>
                        <pre class="quote-code" @click="highlightCode(comment)">{{ comment.text }}</pre>
                    </div>
                    <!-- 评论内容展示 -->
                    <div class="comment-content md-preview-body" v-html="renderMarkdown(comment.content)"></div>
                    
                    <!-- 改进代码展示区域，仅当有改进代码时显示 -->
                    <div v-if="comment.improvementText" class="comment-improvement">
                        <div class="improvement-header">
                            <i class="fas fa-magic"></i>
                            <span>改进代码</span>
                        </div>
                        <pre class="improvement-code">{{ comment.improvementText }}</pre>
                    </div>
                    
                    <!-- 评论操作 -->
                    <div class="comment-actions">
                        <button 
                            v-if="comment.status === 'pending'"
                            @click="resolveComment(comment.key)"
                            class="action-button resolve-button"
                            title="标记为已解决"
                        >
                            <i class="fas fa-check"></i>
                            解决
                        </button>
                        
                        <button 
                            v-if="comment.status === 'resolved'"
                            @click="reopenComment(comment.key)"
                            class="action-button reopen-button"
                            title="重新打开"
                        >
                            <i class="fas fa-undo"></i>
                            重开
                        </button>
                        
                        <button 
                            @click="deleteComment(comment.key)"
                            class="action-button delete-button"
                            title="删除评论"
                        >
                            <i class="fas fa-trash"></i>
                            删除
                        </button>
                    </div>
                </div>
            </article>
        </div>
        
        <!-- 加载状态 - 优先显示 -->
        <div v-if="commentsLoading" class="loading-container" role="status" aria-live="polite">
            <div class="loading-spinner" aria-hidden="true"></div>
            <div class="loading-text">正在加载评论...</div>
        </div>
        
        <!-- 未选中文件状态 -->
        <div v-else-if="!file && (!renderComments || renderComments.length === 0)" class="no-file-state" role="status">
            <div class="no-file-icon" aria-hidden="true">
                <i class="fas fa-file-alt"></i>
            </div>
            <div class="no-file-title">未选中文件</div>
            <div class="no-file-subtitle">请从左侧文件树中选择一个文件来查看评论</div>
        </div>
        
        <!-- 无评论状态 -->
        <div v-else-if="file && (!renderComments || renderComments.length === 0)" class="no-comments-state" role="status">
            <div class="no-comments-icon" aria-hidden="true">
                <i class="fas fa-comment-slash"></i>
            </div>
            <div class="no-comments-title">暂无评论</div>
            <div class="no-comments-subtitle">开始代码评审，添加第一个评论</div>
        </div>
    </div>

    <!-- 评论者编辑模态框 -->
    <div v-if="showCommenterEditor" class="commenter-editor-modal" @click="closeCommenterEditor">
        <div class="commenter-editor-content" @click.stop>
            <div class="editor-header">
                <h3 class="editor-title">{{ editingCommenter && !editingCommenter._id ? '添加评论者' : '编辑评论者' }}</h3>
                <button @click="closeCommenterEditor" class="close-btn" title="关闭">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="editor-body">
                <!-- 评论者列表 - 仅在非编辑模式下显示 -->
                <div v-if="!editingCommenter" class="commenter-list">
                    <div v-if="commenters.length > 0" class="commenter-items">
                        <!-- 现有评论者列表 -->
                        <div 
                            v-for="(commenter, index) in commenters" 
                            :key="commenter.key"
                            class="commenter-item"
                        >
                            <div class="commenter-display">
                                <div class="commenter-info">
                                    <div class="commenter-avatar-preview" :style="getCommenterAvatar(commenter)">
                                        {{ getCommenterAvatar(commenter).text }}
                                    </div>
                                    <div class="commenter-details">
                                        <div class="commenter-name">{{ commenter.name }}</div>
                                        <div class="commenter-id">ID: {{ commenter.key }}</div>
                                        <div class="commenter-model" v-if="commenter.model">
                                            <i class="fas fa-robot"></i>
                                            {{ getModelDisplayName(commenter.model) }}
                                        </div>
                                    </div>
                                </div>
                                <div class="commenter-actions">
                                    <button @click="editCommenter(commenter)" class="edit-btn" title="编辑">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button @click="deleteCommenter(commenter)" class="delete-btn" title="删除">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div v-else class="commenter-empty">
                        <div class="empty-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="empty-title">暂无评论者</div>
                        <div class="empty-subtitle">点击下方按钮添加第一个评论者</div>
                        <button @click="addNewCommenter" class="add-first-commenter-btn">
                            <i class="fas fa-plus"></i>
                            添加评论者
                        </button>
                    </div>
                </div>
                
                <!-- 统一的编辑表单 -->
                <div v-if="editingCommenter" class="commenter-edit-form">
                    <div class="form-group">
                        <label>姓名:</label>
                        <input 
                            v-model="editingCommenter.name" 
                            type="text" 
                            class="form-input"
                            placeholder="输入评论者姓名"
                        />
                    </div>
                    
                    <div class="form-group">
                        <label>头像URL (可选):</label>
                        <input 
                            v-model="editingCommenter.avatar" 
                            type="text" 
                            class="form-input"
                            placeholder="输入头像URL"
                        />
                    </div>
                    <div class="form-group">
                        <label>模型选择:</label>
                        <input 
                            v-model="editingCommenter.model" 
                            type="text" 
                            class="form-input"
                            placeholder="输入AI模型名称，如：gpt-4, claude-3-opus, gemini-pro"
                            aria-label="输入AI模型名称"
                        />
                    </div>
                    
                    <div class="form-group">
                        <label>系统提示词:</label>
                        <textarea 
                            v-model="editingCommenter.forSystem" 
                            class="form-textarea"
                            placeholder="输入系统提示词"
                            rows="12"
                        ></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>模型参数:</label>
                        <div class="model-params">
                            <div class="param-group">
                                <label class="param-label">温度 (Temperature):</label>
                                <input 
                                    v-model.number="editingCommenter.temperature" 
                                    type="number" 
                                    min="0" 
                                    max="2" 
                                    step="0.1"
                                    class="form-input param-input"
                                    placeholder="0.7"
                                />
                                <span class="param-hint">0-2，控制随机性</span>
                            </div>
                            <div class="param-group">
                                <label class="param-label">最大长度 (Max Tokens):</label>
                                <input 
                                    v-model.number="editingCommenter.maxTokens" 
                                    type="number" 
                                    min="1" 
                                    max="8000" 
                                    step="100"
                                    class="form-input param-input"
                                    placeholder="2000"
                                />
                                <span class="param-hint">1-8000，控制回复长度</span>
                            </div>
                            <div class="param-group">
                                <label class="param-label">Top P:</label>
                                <input 
                                    v-model.number="editingCommenter.topP" 
                                    type="number" 
                                    min="0" 
                                    max="1" 
                                    step="0.1"
                                    class="form-input param-input"
                                    placeholder="0.9"
                                />
                                <span class="param-hint">0-1，控制多样性</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button @click="saveCommenter" class="save-btn">
                            <i class="fas fa-save"></i>
                            保存
                        </button>
                        <button @click="cancelEdit" class="cancel-btn">
                            <i class="fas fa-times"></i>
                            取消
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 评论编辑模态框 -->
    <div v-if="showCommentEditor" class="comment-editor-modal" @click="closeCommentEditor">
        <div class="comment-editor-content" @click.stop>
            <div class="editor-header">
                <h3 class="editor-title">编辑评论</h3>
                <button @click="closeCommentEditor" class="close-btn" title="关闭">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="editor-body">
                <div class="comment-edit-form">
                    <!-- 评论信息编辑 -->
                    <div class="form-row">
                        <div class="form-group half-width">
                            <label>评论者:</label>
                            <input 
                                v-model="editingCommentAuthor"
                                type="text" 
                                class="form-input"
                                placeholder="输入评论者姓名"
                            />
                        </div>
                        <div class="form-group half-width">
                            <label>时间:</label>
                            <input 
                                v-model="editingCommentTimestamp"
                                type="datetime-local" 
                                class="form-input"
                            />
                        </div>
                    </div>
                    
                    <!-- 位置信息编辑 -->
                    <div v-if="editingComment && editingComment.rangeInfo" class="form-row">
                        <div class="form-group half-width">
                            <label>开始行:</label>
                            <input 
                                v-model.number="editingRangeInfo.startLine"
                                type="number" 
                                min="1"
                                class="form-input"
                                placeholder="开始行号"
                            />
                        </div>
                        <div class="form-group half-width">
                            <label>结束行:</label>
                            <input 
                                v-model.number="editingRangeInfo.endLine"
                                type="number" 
                                min="1"
                                class="form-input"
                                placeholder="结束行号"
                            />
                        </div>
                    </div>
                    
                    <!-- 引用代码编辑 -->
                    <div class="form-group">
                        <label>引用代码:</label>
                        <textarea 
                            v-model="editingCommentText"
                            class="form-textarea quoted-code-textarea"
                            placeholder="输入引用的代码（可选）"
                            rows="12"
                        ></textarea>
                    </div>
                    
                    <!-- 评论内容编辑 -->
                    <div class="form-group">
                        <label>评论内容:</label>
                        <textarea 
                            v-model="editingCommentContent"
                            class="form-textarea comment-content-textarea"
                            placeholder="编辑评论内容（支持Markdown）"
                            rows="12"
                            @keydown="onCommentEditKeydown"
                        ></textarea>
                        <div class="textarea-hint">
                            <i class="fas fa-info-circle"></i>
                            支持Markdown格式，Ctrl/Cmd + Enter 保存，Esc 取消
                        </div>
                    </div>
                    
                    <!-- 改进代码编辑 -->
                    <div class="form-group">
                        <label>改进代码 (可选):</label>
                        <textarea 
                            v-model="editingImprovementText"
                            class="form-textarea improvement-textarea"
                            placeholder="输入改进后的代码（可选）"
                            rows="12"
                        ></textarea>
                    </div>
                    
                    <!-- 评论类型和状态 -->
                    <div class="form-row">
                        <div class="form-group half-width">
                            <label>评论类型:</label>
                            <select v-model="editingCommentType" class="form-select">
                                <option value="">无类型</option>
                                <option value="suggestion">建议</option>
                                <option value="question">问题</option>
                                <option value="bug">错误</option>
                                <option value="discussion">讨论</option>
                                <option value="praise">表扬</option>
                                <option value="nitpick">细节</option>
                            </select>
                        </div>
                        <div class="form-group half-width">
                            <label>状态:</label>
                            <select v-model="editingCommentStatus" class="form-select">
                                <option value="pending">待处理</option>
                                <option value="resolved">已解决</option>
                                <option value="closed">已关闭</option>
                                <option value="wontfix">不修复</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button 
                            @click="saveEditedComment"
                                class="save-btn"
                                :disabled="editingSaving"
                        >
                            <i class="fas fa-save"></i>
                            保存
                        </button>
                        <button @click="closeCommentEditor" class="cancel-btn">
                            <i class="fas fa-times"></i>
                            取消
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</aside>










