<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YiWeb - 代码审查</title>
    <link rel="stylesheet" href="/views/aicr/index.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <!-- Mermaid.js for diagram rendering -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11.12.0/dist/mermaid.min.js"></script>
</head>
<body>
    <div id="app">
      <!-- 顶部搜索与分类区域 -->
      <header class="header-row" role="banner">
        <section class="search-row">
            <form class="search-box" role="search" aria-label="代码审查搜索">
                <span class="search-logo" aria-hidden="true" @click="openLink('/index.html')">
                    <i class="fas fa-globe" aria-label="代码审查图标"></i>
                </span>
                <div class="search-input-wrapper">
                    <label for="messageInput" class="visually-hidden">搜索输入框</label>
                    <textarea 
                        id="messageInput" 
                        placeholder="搜索网站、标签或描述..." 
                        rows="1" 
                        maxlength="2000"
                        aria-label="搜索输入框"
                        aria-describedby="category-filters"
                        autocomplete="off"
                        spellcheck="false"
                        @keydown="handleMessageInput"
                        @compositionstart="handleCompositionStart"
                        @compositionend="handleCompositionEnd"
                        @input="handleSearchInput"></textarea>
                    
                    <!-- 清除搜索按钮 -->
                    <div class="search-clear" v-if="searchQueryValue">
                        <button 
                            type="button"
                            @click.prevent="clearSearch"
                            class="clear-search-btn"
                            title="清除搜索"
                            aria-label="清除搜索内容"
                        >
                            <i class="fas fa-times" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>
            </form>
            
            <!-- 项目/版本选择器 -->
            <nav class="category-filters" id="category-filters" role="toolbar" aria-label="项目版本过滤器">
                <ul class="filter-buttons">
                    <!-- 级联选择器：项目 -> 版本 -->
                    <li class="cascader-container">
                        <div class="cascader">
                            <label class="visually-hidden" for="projectSelect">项目选择器</label>
                            <select 
                                id="projectSelect"
                                class="filter-btn project-select"
                                v-model="selectedProject"
                                @change="handleProjectChange($event.target.value)"
                                :disabled="loading"
                                :title="selectedProject ? `当前项目: ${selectedProject}` : '选择项目'"
                                aria-label="项目选择器"
                            >
                                <option value="" disabled>选择项目</option>
                                <option 
                                    v-for="project in projects" 
                                    :key="project.id" 
                                    :value="project.id"
                                    :title="`选择项目: ${project.id}`">
                                    {{ project.id }}
                                </option>
                            </select>
                            <label class="visually-hidden" for="versionSelect">版本选择器</label>
                            <select 
                                id="versionSelect"
                                class="filter-btn version-select"
                                v-model="selectedVersion"
                                @change="handleVersionChange"
                                :disabled="!selectedProject || loading"
                                :title="selectedVersion ? `当前版本: ${selectedVersion}` : (selectedProject ? '选择版本' : '请先选择项目')"
                                aria-label="版本选择器"
                            >
                                <option value="" disabled>{{ selectedProject ? '选择版本' : '请先选择项目' }}</option>
                                <option 
                                    v-for="v in (projects.find(p => p.id === selectedProject)?.versions || [])" 
                                    :key="typeof v === 'string' ? v : v.id" 
                                    :value="typeof v === 'string' ? v : v.id"
                                    :title="`选择版本: ${typeof v === 'string' ? v : v.id}`">
                                    {{ typeof v === 'string' ? v : v.id }}
                                </option>
                            </select>
                        </div>
                    </li>
                    
                    <!-- 维护项目与版本按钮（独立项） -->
                    <li v-if="false">
                        <button 
                            type="button"
                            class="filter-btn manage-btn"
                            @click="openProjectVersionManager"
                            :disabled="loading"
                            title="维护项目与版本">
                            <i class="fas fa-wrench" aria-hidden="true"></i>
                            <span>维护</span>
                        </button>
                    </li>
                    <!-- 下载当前项目版本 -->
                    <li>
                        <button 
                            type="button"
                            class="filter-btn"
                            @click="handleDownloadProjectVersion"
                            :disabled="loading || !selectedProject || !selectedVersion"
                            :title="selectedProject && selectedVersion ? `下载 ${selectedProject} / ${selectedVersion}` : '请选择项目与版本后下载'">
                            <i class="fas fa-download" aria-hidden="true"></i>
                            <span>下载</span>
                        </button>
                    </li>
                     <!-- 上传当前项目版本（ZIP） -->
                     <li>
                         <button 
                             type="button"
                             class="filter-btn"
                             @click="triggerUploadProjectVersion"
                             :disabled="loading"
                             :title="selectedProject && selectedVersion ? `上传 ${selectedProject} / ${selectedVersion}` : '请选择项目与版本后上传'">
                             <i class="fas fa-upload" aria-hidden="true"></i>
                             <span>上传</span>
                         </button>
                        <input
                            id="aicrUploadZipInput"
                            ref="uploadZip"
                            type="file" 
                            accept=".zip"
                            @change="handleUploadProjectVersion"
                            style="display:none" 
                            aria-label="上传项目版本ZIP">
                     </li>
                </ul>
            </nav>
            
        </section>
        </header>
        <main class="aicr-main">
            <aside class="aicr-sidebar" aria-label="文件目录树" v-show="!sidebarCollapsed">
                <file-tree 
                    :tree="fileTree" 
                    :selected-file-id="selectedFileId" 
                    :expanded-folders="expandedFolders" 
                    :loading="loading" 
                    :error="errorMessage" 
                    :comments="comments"
                    :collapsed="sidebarCollapsed"
                    @file-select="handleFileSelect" 
                    @folder-toggle="handleFolderToggle"
                    @create-folder="handleCreateFolder"
                    @create-file="handleCreateFile"
                    @rename-item="handleRenameItem"
                    @delete-item="handleDeleteItem"
                    @toggle-collapse="toggleSidebar"
                ></file-tree>
            </aside>
            
            <!-- 侧边栏收起后的展开把手 -->
            <button 
                class="sidebar-expand-handle" 
                v-show="sidebarCollapsed"
                @click="toggleSidebar"
                aria-label="展开文件目录树"
                title="展开文件目录树">
                <i class="fas fa-chevron-right" aria-hidden="true"></i>
            </button>
            <section class="aicr-code" :class="{ 'with-sidebar-collapsed': sidebarCollapsed, 'with-comments-collapsed': commentsCollapsed }" aria-label="代码区">
                <code-view 
                    :file="currentFile" 
                    :loading="loading" 
                    :error="errorMessage"
                    :comments="currentComments"
                    @comment-delete="handleCommentDelete"
                    @comment-resolve="handleCommentResolve"
                    @comment-reopen="handleCommentReopen"
                    @reload-comments="handleReloadComments"
                ></code-view>
            </section>
            <aside class="aicr-comments" aria-label="评论区" v-show="!commentsCollapsed">
                <comment-panel 
                    :comments="currentComments" 
                    :file="currentFile"
                    :new-comment="newComment" 
                    :loading="loading" 
                    :error="errorMessage" 
                    :collapsed="commentsCollapsed"
                    @comment-submit="handleCommentSubmit" 
                    @comment-input="handleCommentInput"
                    @commenter-select="handleCommenterSelect"
                    @comment-delete="handleCommentDelete"
                    @comment-resolve="handleCommentResolve"
                    @comment-reopen="handleCommentReopen"
                    @toggle-collapse="toggleComments"
                ></comment-panel>
            </aside>
            <!-- 评论区收起后的展开把手 -->
            <button 
                class="comments-expand-handle" 
                v-show="commentsCollapsed"
                @click="toggleComments"
                aria-label="展开评论区"
                title="展开评论区">
                <i class="fas fa-chevron-left" aria-hidden="true"></i>
            </button>
        </main>
        
        <!-- 项目与版本维护弹框 -->
        <section 
            v-if="showPvManager" 
            class="pv-manager-modal" 
            role="dialog" 
            aria-modal="true" 
            aria-labelledby="pv-manager-title"
            tabindex="0"
            @keydown.esc.stop.prevent="closeProjectVersionManager">
            <div class="pv-manager-backdrop" @click="closeProjectVersionManager"></div>
            <div class="pv-manager-dialog" @click.stop>
                <header class="pv-manager-header">
                    <h3 id="pv-manager-title">维护项目与版本</h3>
                    <button class="pv-close-btn" @click="closeProjectVersionManager" aria-label="关闭">
                        <i class="fas fa-times"></i>
                    </button>
                </header>
                <div class="pv-manager-body">
                    <div class="pv-alert" v-if="pvError">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>{{ pvError }}</span>
                    </div>
                    <div class="pv-columns">
                        <div class="pv-left">
                            <div class="pv-section-title">
                                <i class="fas fa-folder"></i>
                                <span>项目列表</span>
                            </div>
                            <div class="pv-add-row">
                                <input type="text" v-model="pvNewProjectId" placeholder="项目ID" aria-label="项目ID" @keydown.enter.prevent="pvAddProject" />
                                <button class="pv-mini-btn" @click="pvAddProject">
                                    <i class="fas fa-plus"></i>
                                    <span>添加项目</span>
                                </button>
                            </div>
                            <ul class="pv-project-list">
                                <li 
                                    v-for="p in pvProjects" 
                                    :key="p.id" 
                                    :class="{ active: pvSelectedProjectId === p.id }">
                                    <button class="pv-project-item" @click="pvSelectProject(p.id)" :title="`选择项目: ${p.id}`">
                                        <i class="fas fa-folder"></i>
                                        <span class="name">{{ p.id }}</span>
                                    </button>
                                    <button class="pv-danger-btn" @click="pvDeleteProject(p.id)" title="删除项目">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </li>
                            </ul>
                        </div>
                        <div class="pv-right">
                            <div class="pv-section-title">
                                <i class="fas fa-code-branch"></i>
                                <span>版本列表</span>
                            </div>
                            <div class="pv-add-row">
                                <input type="text" v-model="pvNewVersionId" placeholder="版本ID" aria-label="版本ID" @keydown.enter.prevent="pvAddVersion" />
                                <button class="pv-mini-btn" @click="pvAddVersion" :disabled="!pvSelectedProjectId">
                                    <i class="fas fa-plus"></i>
                                    <span>添加版本</span>
                                </button>
                            </div>
                            <ul class="pv-version-list">
                                <li v-if="!pvSelectedProjectId" class="pv-empty">请先在左侧选择项目</li>
                                <li v-else 
                                    v-for="v in (pvProjects.find(pp => pp.id === pvSelectedProjectId)?.versions || [])" 
                                    :key="typeof v === 'string' ? v : v.id">
                                    <div class="pv-version-item">
                                        <i class="fas fa-tag"></i>
                                        <span class="name">{{ typeof v === 'string' ? v : v.id }}</span>
                                    </div>
                                    <button class="pv-danger-btn" @click="pvDeleteVersion(typeof v === 'string' ? v : v.id)" title="删除版本">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <footer class="pv-manager-footer">
                    <button class="filter-btn" @click="closeProjectVersionManager" :disabled="loading">
                        <i class="fas fa-times"></i>
                        <span>取消</span>
                    </button>
                    <button class="filter-btn pv-primary-btn" @click="pvSave" :disabled="loading || !pvDirty">
                        <i class="fas fa-save"></i>
                        <span>{{ pvDirty ? '保存' : '已保存' }}</span>
                    </button>
                </footer>
            </div>
        </section>
    </div>

    <!-- 全局加载指示器 -->
    <section id="global-loading-indicator" class="loading-indicator" aria-hidden="true" aria-label="全局加载中">
      <div class="loading-content">
          <div class="loading-spinner" role="status" aria-live="polite" aria-label="正在加载"></div>
          <p class="loading-text" id="loading-text">正在加载...</p>
      </div>
    </section>

    
    
    <!-- 脚本标签移到Vue应用容器外部 -->
    <script type="module" src="/config.js"></script>
    <script type="module" src="/utils/fullscreenViewer.js"></script>
    <script type="module" src="/utils/chartViewer.js"></script>
    <script type="module" src="/utils/mermaid.js"></script>
    <script type="module" src="/utils/mermaidDebug.js"></script>
    <script type="module" src="/utils/mermaidRenderer.js"></script>
    <script type="module" src="/views/aicr/plugins/fileTree/index.js"></script>
    <script type="module" src="/views/aicr/plugins/codeView/index.js"></script>
    <script type="module" src="/views/aicr/plugins/commentPanel/index.js"></script>
    <script type="module" src="/views/aicr/index.js"></script>
    <script type="module" src="/utils/performance.js"></script>
</body>
</html> 













