<div class="enhanced-task-list">
    <div v-if="loading" class="loading-state">
        <i class="fas fa-spinner fa-spin"></i>
        <span>加载中...</span>
    </div>
    <div v-else-if="error" class="error-state">
        <i class="fas fa-exclamation-triangle"></i>
        <h3>加载失败</h3>
        <p>{{ error }}</p>
        <button type="button" @click="$emit('retry')" class="retry-btn">重新加载</button>
    </div>
    <div v-else-if="tasks.length === 0" class="empty-state">
        <div class="empty-state-content">
            <i class="fas fa-tasks"></i>
            <h3>暂无任务</h3>
            <p>开始创建您的第一个任务吧</p>
            <div class="empty-state-actions">
                <button type="button" @click="$emit('create-task')" class="create-task-btn">
                    <i class="fas fa-plus"></i>
                    创建任务
                </button>
                <button type="button" @click="$emit('retry')" class="retry-btn" v-if="error">
                    <i class="fas fa-redo"></i>
                    重新加载
                </button>
            </div>
        </div>
    </div>
    <!-- 卡片视图 -->
    <div v-else-if="viewMode === 'card'" class="task-card-content">
        <div v-for="task in tasks" :key="task.key || task.id" 
             class="task-item-enhanced"
             @click="handleTaskClick(task)"
             @touchstart="startLongPress(task, $event)"
             @touchend="endLongPress"
             @touchcancel="endLongPress"
             @mousedown="startLongPress(task, $event)"
             @mouseup="endLongPress"
             @mouseleave="endLongPress">
            
            <!-- 功能名称标识 -->
            <div class="task-feature-name" v-if="task.featureName">
                <i class="fas fa-tag"></i>
                <span>{{ task.featureName }}</span>
            </div>
            
            <div class="task-header">
                <div class="task-title">{{ task.title }}</div>
                <div class="task-actions">
                    <button 
                        type="button"
                        class="edit-btn" 
                        @click.stop="handleEditTask(task)"
                        title="编辑任务">
                        <i class="fas fa-edit"></i>
                    </button>

                </div>
            </div>
            <div class="task-description" v-if="task.description">{{ task.description }}</div>
            
            <!-- 输入输出信息 -->
            <div class="task-io-section" v-if="task.input || task.output">
                <div class="task-input" v-if="task.input">
                    <div class="io-label">
                        <i class="fas fa-arrow-down"></i>
                        <span>输入</span>
                    </div>
                    <div class="io-content">
                        <div v-if="Array.isArray(task.input)" class="io-array-content">
                            <div v-for="(item, index) in task.input" :key="index" class="io-array-item">
                                <span class="io-item-number">{{ index + 1 }}</span>
                                <span class="io-item-text">{{ item }}</span>
                            </div>
                        </div>
                        <div v-else-if="typeof task.input === 'object' && task.input !== null" class="io-array-content">
                            <div v-for="(item, key) in task.input" :key="key" class="io-array-item">
                                <span class="io-item-number">{{ key }}</span>
                                <span class="io-item-text">{{ item }}</span>
                            </div>
                        </div>
                        <div v-else class="io-text-content">{{ task.input }}</div>
                    </div>
                </div>
                <div class="task-output" v-if="task.output">
                    <div class="io-label">
                        <i class="fas fa-arrow-up"></i>
                        <span>输出</span>
                    </div>
                    <div class="io-content">
                        <div v-if="Array.isArray(task.output)" class="io-array-content">
                            <div v-for="(item, index) in task.output" :key="index" class="io-array-item">
                                <span class="io-item-number">{{ index + 1 }}</span>
                                <span class="io-item-text">{{ item }}</span>
                            </div>
                        </div>
                        <div v-else-if="typeof task.output === 'object' && task.output !== null" class="io-array-content">
                            <div v-for="(item, key) in task.output" :key="key" class="io-array-item">
                                <span class="io-item-number">{{ key }}</span>
                                <span class="io-item-text">{{ item }}</span>
                            </div>
                        </div>
                        <div v-else class="io-text-content">{{ task.output }}</div>
                    </div>
                </div>
            </div>
            
            <!-- 步骤信息 -->
            <div class="task-steps-section" v-if="task.steps && Object.keys(task.steps).length > 0">
                <div class="steps-label">
                    <i class="fas fa-list-ol"></i>
                    <span>执行步骤</span>
                    <div class="steps-progress">
                        {{ getStepsProgress(task).completed }} / {{ getStepsProgress(task).total }}
                    </div>
                </div>
                <div class="steps-content">
                    <div v-for="(step, stepKey) in task.steps" :key="stepKey" 
                         class="step-item"
                         :class="{ 'completed': isStepCompleted(task, stepKey) }">
                        <div class="step-checkbox" @click.stop="toggleStepComplete(task, stepKey)">
                            <i :class="getStepCheckIcon(task, stepKey)" class="step-check-icon"></i>
                        </div>
                        <span class="step-number" :class="{ 'completed': isStepCompleted(task, stepKey) }">
                            {{ getStepNumber(stepKey) }}
                        </span>
                        <span class="step-text" :class="{ 'completed': isStepCompleted(task, stepKey) }">
                            {{ getStepText(step) }}
                        </span>
                    </div>
                </div>
            </div>
            

        </div>
    </div>
    <!-- 列表视图 -->
    <div v-else-if="viewMode === 'list'" class="task-list-view">
        <!-- 列表表头 -->
        <header class="task-list-view__header">
            <div class="task-list-view__header-cell task-list-view__header-cell--info" title="任务信息">
                <i class="fas fa-tasks"></i>
                <span>任务</span>
            </div>
            <div class="task-list-view__header-cell task-list-view__header-cell--status" title="任务状态">
                <i class="fas fa-flag"></i>
                <span>状态</span>
            </div>
            <div class="task-list-view__header-cell task-list-view__header-cell--priority" title="优先级">
                <i class="fas fa-exclamation-circle"></i>
                <span>优先级</span>
            </div>
            <div class="task-list-view__header-cell task-list-view__header-cell--progress" title="完成进度">
                <i class="fas fa-chart-line"></i>
                <span>进度</span>
            </div>
            <div class="task-list-view__header-cell task-list-view__header-cell--date" title="截止日期">
                <i class="fas fa-calendar-alt"></i>
                <span>截止日期</span>
            </div>
            <div class="task-list-view__header-cell task-list-view__header-cell--actions" title="操作">
                <i class="fas fa-cog"></i>
                <span>操作</span>
            </div>
        </header>
        
        <!-- 列表主体 -->
        <div class="task-list-view__body">
            <article v-for="task in tasks" :key="task.key || task.id" 
                     class="task-list-view__item"
                     :class="getTaskItemClasses(task)"
                     @click="handleTaskClick(task)">
                
                <!-- 任务信息列 -->
                <div class="task-list-view__cell task-list-view__cell--info">
                    <div class="task-info">
                        <h3 class="task-info__title">{{ task.title }}</h3>
                        <p class="task-info__description" v-if="task.description">
                            {{ task.description }}
                        </p>
                        
                        
                        <!-- 功能标签 -->
                        <div class="task-info__meta" v-if="task.featureName">
                            <span class="feature-tag">
                                <i class="fas fa-tag"></i>
                                {{ task.featureName }}
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- 状态列 -->
                <div class="task-list-view__cell task-list-view__cell--status">
                    <span class="status-badge" :class="task.status">
                        {{ getStatusLabel(task.status) }}
                    </span>
                </div>
                
                <!-- 优先级列 -->
                <div class="task-list-view__cell task-list-view__cell--priority">
                    <span class="priority-badge" :class="task.priority">
                        {{ getPriorityLabel(task.priority) }}
                    </span>
                </div>
                
                <!-- 进度列 -->
                <div class="task-list-view__cell task-list-view__cell--progress">
                    <div class="progress-bar">
                        <div class="progress-bar__fill" :style="{ width: getTaskProgress(task) + '%' }"></div>
                    </div>
                    <span class="progress-text">{{ getTaskProgress(task) }}%</span>
                </div>
                
                <!-- 日期列 -->
                <div class="task-list-view__cell task-list-view__cell--date">
                    <span class="date-text" :class="{ 'overdue': isOverdue(task.dueDate) }">
                        {{ formatDate(task.dueDate) }}
                    </span>
                </div>
                
                <!-- 操作列 -->
                <div class="task-list-view__cell task-list-view__cell--actions">
                    <button type="button" class="action-btn edit-btn" @click.stop="handleEditTask(task)" title="编辑">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" class="action-btn delete-btn" @click.stop="$emit('task-delete', task)" title="删除">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </article>
        </div>
    </div>
</div>
