<div class="task-editor-overlay" v-if="visible" @click="handleOverlayClick">
    <div class="task-editor-modal" @click.stop>
        <div class="editor-header">
            <h3>{{ isEditing ? '编辑任务' : '创建任务' }}</h3>
            <button type="button" @click="closeEditor" class="close-btn" title="关闭">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="editor-content">
            <form @submit.prevent="handleSubmit" class="task-form">
                <!-- 基本信息（参考需求分析规范） -->
                <div class="form-section">
                    <h4>基本信息</h4>
                    
                    <div class="form-group">
                        <label for="taskTitle">业务场景/任务标题 *</label>
                        <input 
                            id="taskTitle"
                            type="text" 
                            required 
                            placeholder="请描述业务场景或任务标题（问题级需求描述）"
                            class="form-input"
                            :value="formData.title"
                            @input="handleTitleInput">
                        <small class="form-hint">提示：从用户视角描述业务场景，而非技术实现方案</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskDescription">场景描述/问题分析</label>
                        <textarea 
                            id="taskDescription"
                            v-model="formData.description" 
                            placeholder="请描述业务场景的详细情况：\n- 场景目的和参与者\n- 触发条件\n- 当前如何应对该问题（现状）\n- 问题的影响分析"
                            class="form-textarea"
                            rows="4"></textarea>
                        <small class="form-hint">提示：参考业务场景分析方法，描述场景—挑战—方案</small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="taskPriority">优先级</label>
                            <select id="taskPriority" v-model="formData.priority" class="form-select">
                                <option value="none">无</option>
                                <option value="low">低</option>
                                <option value="medium">中</option>
                                <option value="high">高</option>
                                <option value="critical">紧急</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="taskStatus">状态</label>
                            <select id="taskStatus" v-model="formData.status" class="form-select">
                                <option value="backlog">待办</option>
                                <option value="todo">计划中</option>
                                <option value="in_progress">进行中</option>
                                <option value="in_review">待审核</option>
                                <option value="testing">测试中</option>
                                <option value="completed">已完成</option>
                                <option value="cancelled">已取消</option>
                                <option value="on_hold">暂停</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="taskType">任务类型</label>
                            <select id="taskType" v-model="formData.type" class="form-select">
                                <option value="task">任务</option>
                                <option value="bug">缺陷</option>
                                <option value="feature">功能</option>
                                <option value="improvement">改进</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="taskDueDate">截止日期</label>
                            <input 
                                id="taskDueDate"
                                v-model="formData.dueDate" 
                                type="date" 
                                class="form-input">
                        </div>
                    </div>
                </div>
                
                <!-- 业务场景分析（参考SOP任务9：业务场景分析） -->
                <div class="form-section input-output-section">
                    <h4>
                        <i class="fas fa-exchange-alt"></i>
                        业务场景分析（场景—挑战—方案）
                    </h4>
                    
                    <!-- 场景概述 -->
                    <div class="form-group">
                        <label for="scenarioOverview">场景概述</label>
                        <textarea 
                            id="scenarioOverview"
                            v-model="formData.scenarioOverview" 
                            placeholder="请描述业务场景概述：&#10;&#10;1. 场景目的：&#10;2. 参与者：&#10;3. 触发条件：&#10;4. 当前如何应对该问题（现状）：&#10;5. 使用频率和影响范围："
                            class="form-textarea"
                            rows="5"></textarea>
                        <small class="form-hint">提示：参考业务场景分析方法，清晰描述场景的目的、参与者、触发条件</small>
                    </div>
                    
                    <div class="input-output-container">
                        <div class="input-output-item input-item">
                            <div class="input-output-header">
                                <label for="taskInput" class="input-output-label">
                                    <i class="fas fa-arrow-down"></i>
                                    业务步骤（用户意图）
                                </label>
                                <div class="char-counter" v-if="formData.input">
                                    {{ formData.input.length }}/500
                                </div>
                            </div>
                            <div class="input-output-wrapper">
                                <textarea 
                                    id="taskInput"
                                    v-model="formData.input" 
                                    placeholder="请描述业务步骤（重在人机交互、用户意图）：&#10;&#10;用户意图描述&#10;人机交互过程&#10;系统响应&#10;预期结果&#10;&#10;提示：重在人机交互而非人机界面，重在用户意图而非用户动作"
                                    class="form-textarea input-output-textarea"
                                    rows="6"
                                    maxlength="500"
                                    @focus="handleInputFocus"
                                    @blur="handleInputBlur">
                                </textarea>
                                <div class="input-output-icon">
                                    <i class="fas fa-download"></i>
                                </div>
                            </div>
                            <div class="input-output-hint" v-if="!formData.input">
                                <i class="fas fa-lightbulb"></i>
                                提示：重在人机交互而非人机界面，重在用户意图而非用户动作
                            </div>
                        </div>
                        
                        <div class="input-output-arrow">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                        
                        <div class="input-output-item output-item">
                            <div class="input-output-header">
                                <label for="taskOutput" class="input-output-label">
                                    <i class="fas fa-arrow-up"></i>
                                    困难与功能（挑战—方案）
                                </label>
                                <div class="char-counter" v-if="formData.output">
                                    {{ formData.output.length }}/500
                                </div>
                            </div>
                            <div class="input-output-wrapper">
                                <textarea 
                                    id="taskOutput"
                                    v-model="formData.output" 
                                    placeholder="请描述困难分析与导出功能：&#10;&#10;遍历步骤分析困难：&#10;- 步骤1可能遇到的困难：&#10;- 步骤2可能遇到的困难：&#10;&#10;从困难中导出功能：&#10;- 功能1：解决困难1&#10;- 功能2：解决困难2&#10;&#10;提示：参考业务场景分析方法，遍历步骤分析困难，导出功能"
                                    class="form-textarea input-output-textarea"
                                    rows="6"
                                    maxlength="500"
                                    @focus="handleOutputFocus"
                                    @blur="handleOutputBlur">
                                </textarea>
                                <div class="input-output-icon">
                                    <i class="fas fa-upload"></i>
                                </div>
                            </div>
                            <div class="input-output-hint" v-if="!formData.output">
                                <i class="fas fa-lightbulb"></i>
                                提示：遍历步骤分析困难，从困难中导出系统需要提供的功能
                            </div>
                        </div>
                    </div>
                    
                    <!-- 环境与规则 -->
                    <div class="form-group">
                        <label for="environmentAndRules">环境与规则</label>
                        <textarea 
                            id="environmentAndRules"
                            v-model="formData.environmentAndRules" 
                            placeholder="请描述环境与规则：&#10;&#10;业务规则：&#10;- 规则1：&#10;- 规则2：&#10;&#10;环境约束：&#10;- 约束1：&#10;- 约束2："
                            class="form-textarea"
                            rows="4"></textarea>
                        <small class="form-hint">提示：识别业务规则和环境约束</small>
                    </div>
                    
                    <!-- 快速模板 -->
                    <div class="input-output-templates" v-if="showTemplates">
                        <div class="templates-header">
                            <span>快速模板</span>
                            <button type="button" @click="showTemplates = false" class="close-templates-btn" title="关闭模板">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="templates-grid">
                            <button type="button" @click="applyTemplate('api')" class="template-btn">
                                <i class="fas fa-code"></i>
                                API接口
                            </button>
                            <button type="button" @click="applyTemplate('ui')" class="template-btn">
                                <i class="fas fa-palette"></i>
                                UI组件
                            </button>
                            <button type="button" @click="applyTemplate('data')" class="template-btn">
                                <i class="fas fa-database"></i>
                                数据处理
                            </button>
                            <button type="button" @click="applyTemplate('test')" class="template-btn">
                                <i class="fas fa-vial"></i>
                                测试用例
                            </button>
                        </div>
                    </div>
                    
                    <div class="input-output-actions">
                        <button type="button" @click="showTemplates = !showTemplates" class="template-toggle-btn">
                            <i class="fas fa-magic"></i>
                            {{ showTemplates ? '隐藏模板' : '快速模板' }}
                        </button>
                        <button type="button" @click="clearInputOutput" class="clear-btn" v-if="formData.input || formData.output">
                            <i class="fas fa-trash"></i>
                            清空
                        </button>
                    </div>
                </div>
                
                <!-- 执行步骤（参考业务场景分析：场景—挑战—方案） -->
                <div class="form-section">
                    <h4>业务步骤（场景—挑战—方案）</h4>
                    <small class="form-hint" style="display: block; margin-bottom: 12px; color: #888;">
                        提示：参考业务场景分析方法，细化业务场景的业务步骤（重在人机交互、用户意图）
                    </small>
                    <div class="steps-container">
                        <div v-for="(step, index) in formData.steps" :key="index" class="step-item">
                            <div class="step-header">
                                <span class="step-number">业务步骤 {{ index + 1 }}</span>
                                <button 
                                    type="button" 
                                    @click="removeStep(index)" 
                                    class="remove-step-btn"
                                    title="删除步骤">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="step-content">
                                <div class="step-input">
                                    <input
                                        type="text" 
                                        v-model="step.text" 
                                        :placeholder="'请描述步骤 ' + (index + 1) + ' 的业务步骤（用户意图，非用户动作）'"
                                        class="form-input step-text-input">
                                </div>
                                <label class="step-checkbox-label">
                                    <input 
                                        type="checkbox" 
                                        v-model="step.completed" 
                                        class="step-checkbox">
                                    <span>已完成</span>
                                </label>
                            </div>
                        </div>
                        
                        <button 
                            type="button" 
                            @click="addStep" 
                            class="add-step-btn">
                            <i class="fas fa-plus"></i>
                            <span>添加业务步骤</span>
                        </button>
                    </div>
                </div>
                
                <!-- 操作按钮 -->
                <div class="form-actions">
                    <button type="button" @click="closeEditor" class="btn btn-secondary">
                        取消
                    </button>
                    <button type="submit" class="btn btn-primary" :disabled="submitting">
                        <i v-if="submitting" class="fas fa-spinner fa-spin"></i>
                        {{ isEditing ? '保存修改' : '创建任务' }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
