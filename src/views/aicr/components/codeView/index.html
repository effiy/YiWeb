<section class="code-view-container" role="main" aria-label="代码查看器">
  <div v-if="loading" class="loading-container" role="status" aria-live="polite">
    <div class="loading-spinner" aria-hidden="true"></div>
    <div class="loading-text">正在加载代码...</div>
  </div>
  <div v-else-if="error" class="error-container" role="alert">
    <div class="error-icon" aria-hidden="true">
      <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
    </div>
    <div class="error-message">{{ error }}</div>
  </div>
  <div v-else-if="file" class="code-content" :class="{ editing: isEditingFile, wrap: wrapEnabled }" :style="codeContentStyle">
    <div class="code-header">
      <div class="file-name" :title="fullFilePath">
        <i class="fas fa-file-code" aria-hidden="true"></i>
        <span class="file-name-text">{{ displayFileName }}</span>
      </div>
      <div class="code-actions">
        <button
          v-if="!isEditingFile"
          type="button"
          class="action-button"
          @click="startEditFile"
          :disabled="!file"
          title="编辑文件"
          aria-label="编辑文件"
        >
          <i class="fas fa-pen" aria-hidden="true"></i>
        </button>
        <template v-else>
          <button
            type="button"
            class="action-button"
            :disabled="editSaving"
            @click="saveEditedFile"
            :title="editSaving ? '保存中' : '保存修改'"
            aria-label="保存修改"
          >
            <i class="fas" :class="editSaving ? 'fa-spinner fa-spin' : 'fa-save'" aria-hidden="true"></i>
          </button>
          <button
            type="button"
            class="action-button"
            :disabled="editSaving"
            @click="cancelEditFile"
            title="取消编辑"
            aria-label="取消编辑"
          >
            <i class="fas fa-times" aria-hidden="true"></i>
          </button>
        </template>
        <button
          v-if="!isEditingFile"
          type="button"
          class="action-button"
          @click="downloadCurrentFile"
          :disabled="!file"
          title="下载文件"
          aria-label="下载文件"
        >
          <i class="fas fa-download" aria-hidden="true"></i>
        </button>
        <button
          v-if="!isEditingFile"
          type="button"
          class="action-button"
          @click="openFileInNewTab"
          :disabled="!file"
          title="新标签打开"
          aria-label="新标签打开"
        >
          <i class="fas fa-external-link-alt" aria-hidden="true"></i>
        </button>
        <button
          v-if="!isEditingFile"
          type="button"
          class="action-button"
          @click="copyEntireFile"
          :disabled="!file"
          title="复制代码"
          aria-label="复制代码"
        >
          <i class="fas fa-copy" aria-hidden="true"></i>
        </button>
      </div>
    </div>

    <div v-if="isEditingFile" class="edit-container">
      <textarea
        class="edit-textarea"
        v-model="editingFileContent"
        @keydown="onEditKeydown"
        spellcheck="false"
        placeholder="编辑文件内容..."
        aria-label="编辑文件内容"
      ></textarea>
      <div class="save-error" v-if="saveError">
        <i class="fas fa-exclamation-circle" aria-hidden="true"></i> {{ saveError }}
      </div>
    </div>

    <div v-else-if="shouldShowMarkdownPreview" class="markdown-preview-container">
      <div class="markdown-preview-wrapper">
        <div class="markdown-preview-content md-preview-body">
          <div class="markdown-full-content" v-html="markdownPreviewHtml"></div>
        </div>
      </div>
    </div>

    <div v-else class="code-reader">
      <div class="code-toolbar">
        <div class="toolbar-left">
          <div class="search-box" role="search">
            <i class="fas fa-search" aria-hidden="true"></i>
            <input
              ref="searchInput"
              class="search-input"
              v-model="searchQuery"
              type="text"
              autocomplete="off"
              spellcheck="false"
              placeholder="搜索 (Ctrl+F)"
              aria-label="搜索代码"
            />
            <button
              v-if="searchQuery"
              type="button"
              class="icon-button"
              @click="clearSearch"
              title="清除搜索"
              aria-label="清除搜索"
            >
              <i class="fas fa-times" aria-hidden="true"></i>
            </button>
          </div>
          <div class="search-status" v-if="searchQuery">
            <span class="search-count">{{ searchMatchCount ? (activeMatchIndex + 1) : 0 }}/{{ searchMatchCount }}</span>
            <button
              type="button"
              class="icon-button"
              @click="findPrevMatch"
              :disabled="!searchMatchCount"
              title="上一个匹配 (Shift+F3)"
              aria-label="上一个匹配"
            >
              <i class="fas fa-chevron-up" aria-hidden="true"></i>
            </button>
            <button
              type="button"
              class="icon-button"
              @click="findNextMatch"
              :disabled="!searchMatchCount"
              title="下一个匹配 (F3)"
              aria-label="下一个匹配"
            >
              <i class="fas fa-chevron-down" aria-hidden="true"></i>
            </button>
          </div>
        </div>
        <div class="toolbar-right">
          <button
            type="button"
            class="icon-button"
            :class="{ active: wrapEnabled }"
            @click="toggleWrap"
            title="自动换行"
            aria-label="自动换行"
          >
            <i class="fas fa-align-left" aria-hidden="true"></i>
          </button>
          <button
            type="button"
            class="icon-button"
            @click="decreaseFont"
            :disabled="fontSize <= fontSizeMin"
            title="减小字号"
            aria-label="减小字号"
          >
            <i class="fas fa-minus" aria-hidden="true"></i>
          </button>
          <button
            type="button"
            class="icon-button"
            @click="increaseFont"
            :disabled="fontSize >= fontSizeMax"
            title="增大字号"
            aria-label="增大字号"
          >
            <i class="fas fa-plus" aria-hidden="true"></i>
          </button>
          <button
            type="button"
            class="icon-button"
            @click="resetFont"
            title="重置字号"
            aria-label="重置字号"
          >
            <i class="fas fa-rotate-left" aria-hidden="true"></i>
          </button>
        </div>
      </div>

      <div class="code-scroll" tabindex="0" aria-label="代码区域">
        <pre class="code-block" :class="'language-' + languageType">
          <code
            v-for="(line, index) in codeLines"
            :key="index + 1"
            :id="'L' + (index + 1)"
            :class="[
              'code-line',
              highlightedLines.includes(index + 1) ? 'highlight' : '',
              isActiveMatchLine(index + 1) ? 'active-match' : ''
            ]"
            :data-line="index + 1"
          >
            <span class="line-number" role="button" tabindex="0" @click="onLineNumberClick(index + 1)">{{ index + 1 }}</span>
            <span class="line-content" v-html="renderLineContent(line) || ' '"></span>
          </code>
        </pre>
      </div>
    </div>
  </div>
  <div v-else class="empty-container" role="status" aria-live="polite" @click="focusFileTree">
    <div class="empty-card">
      <div class="empty-hero" aria-hidden="true">
        <div class="empty-icon" aria-hidden="true">
          <i class="fas fa-file-code" aria-hidden="true"></i>
        </div>
      </div>
      <div class="empty-title">未选择文件</div>
      <div class="empty-subtitle">从左侧文件树选择一个文件开始查看</div>
      <div class="empty-actions">
        <button type="button" class="empty-btn primary" @click.stop="emitCreateSession" aria-label="新建会话">
          <i class="fas fa-plus" aria-hidden="true"></i>
          <span>新建会话</span>
        </button>
      </div>
    </div>
  </div>
</section>
