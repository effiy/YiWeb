<section class="code-view-container" role="main" aria-label="代码查看器">
  <base-loading v-if="loading" text="正在加载代码..."></base-loading>
  <base-error-state
    v-else-if="error"
    :message="error"
    icon-class="fas fa-exclamation-triangle"
  ></base-error-state>
  <div v-else-if="file" class="code-content" :class="{ editing: isEditingFile, wrap: wrapEnabled }" :style="codeContentStyle">
    <div class="code-header">
      <div class="file-name" :title="fullFilePath">
        <i class="fas fa-file-code" aria-hidden="true"></i>
        <span class="file-name-text">{{ displayFileName }}</span>
      </div>
      <div class="code-actions">
        <button
          v-if="!isEditingFile"
          type="button"
          class="action-button"
          @click="startEditFile"
          :disabled="!file"
          title="编辑文件"
          aria-label="编辑文件"
        >
          <i class="fas fa-pen" aria-hidden="true"></i>
        </button>
        <template v-else>
          <button
            type="button"
            class="action-button"
            :disabled="editSaving"
            @click="saveEditedFile"
            :title="editSaving ? '保存中' : '保存修改'"
            aria-label="保存修改"
          >
            <i class="fas" :class="editSaving ? 'fa-spinner fa-spin' : 'fa-save'" aria-hidden="true"></i>
          </button>
          <button
            type="button"
            class="action-button"
            :disabled="editSaving"
            @click="cancelEditFile"
            title="取消编辑"
            aria-label="取消编辑"
          >
            <i class="fas fa-times" aria-hidden="true"></i>
          </button>
        </template>
        <button
          v-if="!isEditingFile"
          type="button"
          class="action-button"
          @click="downloadCurrentFile"
          :disabled="!file"
          title="下载文件"
          aria-label="下载文件"
        >
          <i class="fas fa-download" aria-hidden="true"></i>
        </button>
        <button
          v-if="!isEditingFile"
          type="button"
          class="action-button"
          @click="copyEntireFile"
          :disabled="!file"
          title="复制代码"
          aria-label="复制代码"
        >
          <i class="fas fa-copy" aria-hidden="true"></i>
        </button>
      </div>
    </div>

    <div v-if="isEditingFile" class="edit-container">
      <textarea
        class="edit-textarea"
        v-model="editingFileContent"
        @keydown="onEditKeydown"
        spellcheck="false"
        placeholder="编辑文件内容..."
        aria-label="编辑文件内容"
      ></textarea>
      <div class="save-error" v-if="saveError">
        <i class="fas fa-exclamation-circle" aria-hidden="true"></i> {{ saveError }}
      </div>
    </div>

    <div v-else-if="shouldShowMarkdownPreview" class="markdown-preview-container">
      <div class="markdown-preview-wrapper">
        <markdown-view class="markdown-preview-content md-preview-body" :content="rawContent" mode="markdown" :show-toc="true"></markdown-view>
      </div>
    </div>

    <div v-else class="code-reader">
      <div class="code-toolbar">
        <div class="toolbar-left">
          <div class="search-box" role="search">
            <i class="fas fa-search" aria-hidden="true"></i>
            <input
              ref="searchInput"
              class="search-input"
              v-model="searchQuery"
              type="text"
              autocomplete="off"
              spellcheck="false"
              placeholder="搜索 (Ctrl+F)"
              aria-label="搜索代码"
            />
            <base-icon-button
              v-if="searchQuery"
              class-name="icon-button"
              title="清除搜索"
              aria-label="清除搜索"
              @click="clearSearch"
            >
              <i class="fas fa-times" aria-hidden="true"></i>
            </base-icon-button>
          </div>
          <div class="search-status" v-if="searchQuery">
            <span class="search-count">{{ searchMatchCount ? (activeMatchIndex + 1) : 0 }}/{{ searchMatchCount }}</span>
            <base-icon-button
              class-name="icon-button"
              :disabled="!searchMatchCount"
              title="上一个匹配 (Shift+F3)"
              aria-label="上一个匹配"
              @click="findPrevMatch"
            >
              <i class="fas fa-chevron-up" aria-hidden="true"></i>
            </base-icon-button>
            <base-icon-button
              class-name="icon-button"
              :disabled="!searchMatchCount"
              title="下一个匹配 (F3)"
              aria-label="下一个匹配"
              @click="findNextMatch"
            >
              <i class="fas fa-chevron-down" aria-hidden="true"></i>
            </base-icon-button>
          </div>
        </div>
        <div class="toolbar-right">
          <base-icon-button
            class-name="icon-button"
            :active="wrapEnabled"
            title="自动换行"
            aria-label="自动换行"
            @click="toggleWrap"
          >
            <i class="fas fa-align-left" aria-hidden="true"></i>
          </base-icon-button>
          <base-icon-button
            class-name="icon-button"
            :disabled="fontSize <= fontSizeMin"
            title="减小字号"
            aria-label="减小字号"
            @click="decreaseFont"
          >
            <i class="fas fa-minus" aria-hidden="true"></i>
          </base-icon-button>
          <base-icon-button
            class-name="icon-button"
            :disabled="fontSize >= fontSizeMax"
            title="增大字号"
            aria-label="增大字号"
            @click="increaseFont"
          >
            <i class="fas fa-plus" aria-hidden="true"></i>
          </base-icon-button>
          <base-icon-button
            class-name="icon-button"
            title="重置字号"
            aria-label="重置字号"
            @click="resetFont"
          >
            <i class="fas fa-rotate-left" aria-hidden="true"></i>
          </base-icon-button>
        </div>
      </div>

      <div class="code-scroll" tabindex="0" aria-label="代码区域">
        <pre class="code-block" :class="'language-' + languageType">
          <code
            v-for="(line, index) in codeLines"
            :key="index + 1"
            :id="'L' + (index + 1)"
            :class="[
              'code-line',
              highlightedLines.includes(index + 1) ? 'highlight' : '',
              isActiveMatchLine(index + 1) ? 'active-match' : ''
            ]"
            :data-line="index + 1"
          >
            <span class="line-number" role="button" tabindex="0" @click="onLineNumberClick(index + 1)">{{ index + 1 }}</span>
            <span class="line-content" v-html="renderLineContent(line) || ' '"></span>
          </code>
        </pre>
      </div>
    </div>
  </div>
  <base-empty-state
    v-else
    wrapper-class="empty-container"
    card-class="empty-card"
    title="未选择文件"
    subtitle="从左侧文件树选择一个文件开始查看"
    title-class="empty-title"
    subtitle-class="empty-subtitle"
    @click="focusFileTree"
  >
    <template #icon>
      <div class="empty-hero" aria-hidden="true">
        <div class="empty-icon" aria-hidden="true">
          <i class="fas fa-file-code" aria-hidden="true"></i>
        </div>
      </div>
    </template>
    <div class="empty-actions">
      <base-button variant="primary" size="small" @click.stop="emitCreateSession" aria-label="新建会话">
        <i class="fas fa-plus" aria-hidden="true"></i>
        <span>新建会话</span>
      </base-button>
    </div>
  </base-empty-state>
</section>
