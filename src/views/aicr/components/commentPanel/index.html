<!-- 代码评审评论面板组件模板 -->
<aside class="comment-panel-container" :class="{ 'collapsed': collapsed }" role="complementary" aria-label="代码评审评论面板">
    <!-- 收起/展开按钮 -->
    <div class="comment-panel-toggle" @click="$emit('toggle-collapse')" :title="collapsed ? '展开评论区' : '收起评论区'">
        <i class="fas fa-chevron-right" :class="{ 'rotated': collapsed }"></i>
    </div>
    
    <!-- 全局加载状态 -->
    <div v-if="loading || commentsLoading" class="loading-container" role="status" aria-live="polite">
        <div class="loading-spinner" aria-hidden="true"></div>
        <div class="loading-text">正在加载评论...</div>
    </div>

    <!-- 错误状态 -->
    <div v-else-if="error" class="error-container" role="alert" aria-live="polite">
        <div class="error-icon" aria-hidden="true">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="error-text">{{ error }}</div>
    </div>

    <!-- 评论内容 -->
    <div v-else class="comment-panel-content">
        <!-- 评论列表 -->
        <div v-if="renderComments && renderComments.length > 0" class="comment-list" role="list">
            <!-- 调试信息 -->
            <div v-if="false" class="debug-info" style="background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; font-size: 12px;">
                <p>调试信息:</p>
                <p>评论数量: {{ renderComments.length }}</p>
                <p>文件信息: {{ file ? file.name : '无文件' }}</p>
                <p>加载状态: {{ loading }}</p>
                <p>错误信息: {{ error }}</p>
            </div>
            <article 
                v-for="comment in renderComments" 
                :key="comment.key"
                class="comment-item"
                :class="getCommentStatusClass(comment.status)"
                role="listitem"
            >
                <!-- 评论头部 -->
                <div class="comment-header-section">
                    <div class="comment-meta">
                        <div class="comment-author-info">
                            <div class="comment-avatar" :style="getAuthorAvatar(comment.author)">
                                {{ getAuthorAvatar(comment.author).text }}
                            </div>
                            <div class="comment-author-details">
                                <span class="comment-author">{{ comment.author }}</span>
                                <time class="comment-time" :datetime="comment.timestamp">
                                    {{ formatTime(comment.timestamp) }}
                                </time>
                            </div>
                        </div>
                        
                        <!-- 评论类型和状态 -->
                        <div class="comment-badges">
                            <span v-if="comment.type" class="comment-type" :class="`type-${comment.type}`">
                                <i :class="getCommentTypeIcon(comment.type)"></i>
                                {{ getCommentTypeLabel(comment.type) }}
                            </span>
                            <span v-if="comment.status" class="comment-status" :class="`status-${comment.status}`">
                                <i :class="getCommentStatusIcon(comment.status)"></i>
                                {{ getCommentStatusLabel(comment.status) }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- 评论内容 -->
                <div class="comment-body">
                    <div v-if="comment.text" class="comment-quote">
                        <div class="quote-header">
                            <i class="fas fa-quote-left"></i>
                            <span>引用代码</span>
                        </div>
                        <pre class="quote-code">{{ comment.text }}</pre>
                    </div>
                    <!-- 评论内容展示 -->
                    <div class="comment-content md-preview-body" v-html="renderMarkdown(comment.content)"></div>
                    
                    <!-- 改进代码展示区域，仅当有改进代码时显示 -->
                    <div v-if="comment.improvementText" class="comment-improvement">
                        <div class="improvement-header">
                            <i class="fas fa-magic"></i>
                            <span>改进代码</span>
                        </div>
                        <pre class="improvement-code">{{ comment.improvementText }}</pre>
                    </div>
                    
                    <!-- 评论操作 -->
                    <div class="comment-actions">
                        <button 
                            type="button"
                            v-if="comment.status === 'pending'"
                            @click="resolveComment(comment.key)"
                            class="action-button resolve-button"
                            title="标记为已解决"
                        >
                            <i class="fas fa-check"></i>
                            解决
                        </button>
                        
                        <button 
                            type="button"
                            v-if="comment.status === 'resolved'"
                            @click="reopenComment(comment.key)"
                            class="action-button reopen-button"
                            title="重新打开"
                        >
                            <i class="fas fa-undo"></i>
                            重开
                        </button>
                        
                        <button 
                            type="button"
                            v-if="comment.author === '手动评论'"
                            @click="openCommentEditor(comment)"
                            class="action-button resolve-button"
                            title="编辑评论"
                        >
                            <i class="fas fa-edit"></i>
                            编辑
                        </button>
                        
                        <button 
                            type="button"
                            @click="deleteComment(comment.key)"
                            class="action-button resolve-button"
                            :class="{ 'deleting': deletingComments[comment.key] }"
                            :disabled="deletingComments[comment.key]"
                            title="删除评论"
                            :aria-label="`删除评论 ${comment.author}`"
                        >
                            <i class="fas" :class="deletingComments[comment.key] ? 'fa-spinner fa-spin' : 'fa-trash'"></i>
                            <span v-if="!deletingComments[comment.key]">删除</span>
                            <span v-else>删除中...</span>
                        </button>
                    </div>
                </div>
            </article>
        </div>
        
        <!-- 加载状态 - 优先显示 -->
        <div v-if="commentsLoading" class="loading-container" role="status" aria-live="polite">
            <div class="loading-spinner" aria-hidden="true"></div>
            <div class="loading-text">正在加载评论...</div>
        </div>
        
        <!-- 未选中文件状态 -->
        <div v-else-if="!file && (!renderComments || renderComments.length === 0)" class="no-file-state" role="status">
            <div class="no-file-icon" aria-hidden="true">
                <i class="fas fa-file-alt"></i>
            </div>
            <div class="no-file-title">未选中文件</div>
            <div class="no-file-subtitle">请从左侧文件树中选择一个文件来查看评论</div>
        </div>
        
        <!-- 无评论状态 -->
        <div v-else-if="file && (!renderComments || renderComments.length === 0)" class="no-comments-state" role="status">
            <div class="no-comments-icon" aria-hidden="true">
                <i class="fas fa-comment-slash"></i>
            </div>
            <div class="no-comments-title">暂无评论</div>
            <div class="no-comments-subtitle">开始代码评审，添加第一个评论</div>
        </div>
    </div>

    <!-- 评论编辑模态框 -->
    <div v-if="showCommentEditor" class="comment-editor-modal" @click="closeCommentEditor">
        <div class="comment-editor-content" @click.stop>
            <div class="editor-header">
                <h3 class="editor-title">编辑评论</h3>
                <button type="button" @click="closeCommentEditor" class="close-btn" title="关闭">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="editor-body">
                <div class="comment-edit-form">
                    <!-- 评论信息编辑 -->
                    <div class="form-row">
                        <div class="form-group half-width">
                            <label>评论者:</label>
                            <input 
                                v-model="editingCommentAuthor"
                                type="text" 
                                class="form-input"
                                placeholder="输入评论者姓名"
                            />
                        </div>
                        <div class="form-group half-width">
                            <label>时间:</label>
                            <input 
                                v-model="editingCommentTimestamp"
                                type="datetime-local" 
                                class="form-input"
                                aria-label="评论时间"
                            />
                        </div>
                    </div>
                    
                    <!-- 引用代码编辑 -->
                    <div class="form-group">
                        <label>引用代码:</label>
                        <textarea 
                            v-model="editingCommentText"
                            class="form-textarea quoted-code-textarea"
                            placeholder="输入引用的代码（可选）"
                            rows="12"
                        ></textarea>
                    </div>
                    
                    <!-- 评论内容编辑 -->
                    <div class="form-group">
                        <label>评论内容:</label>
                        <textarea 
                            v-model="editingCommentContent"
                            class="form-textarea comment-content-textarea"
                            placeholder="编辑评论内容（支持Markdown）"
                            rows="12"
                            @keydown="onCommentEditKeydown"
                        ></textarea>
                        <div class="textarea-hint">
                            <i class="fas fa-info-circle"></i>
                            支持Markdown格式，Ctrl/Cmd + Enter 保存，Esc 取消
                        </div>
                    </div>
                    
                    <!-- 改进代码编辑 -->
                    <div class="form-group">
                        <label>改进代码 (可选):</label>
                        <textarea 
                            v-model="editingImprovementText"
                            class="form-textarea improvement-textarea"
                            placeholder="输入改进后的代码（可选）"
                            rows="12"
                        ></textarea>
                    </div>
                    
                    <!-- 评论类型和状态 -->
                    <div class="form-row">
                        <div class="form-group half-width">
                            <label>评论类型:</label>
                            <select v-model="editingCommentType" class="form-select" aria-label="评论类型">
                                <option value="">无类型</option>
                                <option value="suggestion">建议</option>
                                <option value="question">问题</option>
                                <option value="bug">错误</option>
                                <option value="discussion">讨论</option>
                                <option value="praise">表扬</option>
                                <option value="nitpick">细节</option>
                            </select>
                        </div>
                        <div class="form-group half-width">
                            <label>状态:</label>
                            <select v-model="editingCommentStatus" class="form-select" aria-label="评论状态">
                                <option value="pending">待处理</option>
                                <option value="resolved">已解决</option>
                                <option value="closed">已关闭</option>
                                <option value="wontfix">不修复</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button 
                            type="button"
                            @click="saveEditedComment"
                                class="save-btn"
                                :disabled="editingSaving"
                        >
                            <i class="fas fa-save"></i>
                            保存
                        </button>
                        <button type="button" @click="closeCommentEditor" class="cancel-btn">
                            <i class="fas fa-times"></i>
                            取消
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</aside>










