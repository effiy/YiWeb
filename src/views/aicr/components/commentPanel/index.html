<!-- ‰ª£Á†ÅËØÑÂÆ°ËØÑËÆ∫Èù¢ÊùøÁªÑ‰ª∂Ê®°Êùø -->
<aside class="comment-panel-container" :class="{ 'collapsed': collapsed }" role="complementary" aria-label="‰ª£Á†ÅËØÑÂÆ°ËØÑËÆ∫Èù¢Êùø">
    
    <!-- ÂÖ®Â±ÄÂä†ËΩΩÁä∂ÊÄÅ -->
    <div v-if="loading || commentsLoading" class="loading-container" role="status" aria-live="polite">
        <div class="loading-spinner" aria-hidden="true"></div>
        <div class="loading-text">Ê≠£Âú®Âä†ËΩΩËØÑËÆ∫...</div>
    </div>

    <!-- ÈîôËØØÁä∂ÊÄÅ -->
    <div v-else-if="error" class="error-container" role="alert" aria-live="polite">
        <div class="error-icon" aria-hidden="true">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="error-text">{{ error }}</div>
    </div>

    <!-- ËØÑËÆ∫ÂÜÖÂÆπ -->
    <div v-else class="comment-panel-content">
        <div v-if="isSessionChatMode" class="aicr-session-chat">
            <div v-if="sessionChatLoading" class="loading-container" role="status" aria-live="polite">
                <div class="loading-spinner" aria-hidden="true"></div>
                <div class="loading-text">Ê≠£Âú®Âä†ËΩΩ‰ºöËØù...</div>
            </div>

            <div v-else-if="sessionChatError" class="error-container" role="alert" aria-live="polite">
                <div class="error-icon" aria-hidden="true">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="error-text">{{ sessionChatError }}</div>
            </div>

            <div v-else class="aicr-session-chat-body">
                <div v-if="!sessionChatSession" class="no-file-state" role="status">
                    <div class="no-file-icon" aria-hidden="true">
                        <i class="fas fa-comments"></i>
                    </div>
                    <div class="no-file-title">Êú™ÈÄâÊã©‰ºöËØù</div>
                    <div class="no-file-subtitle">ËØ∑‰ªéÂ∑¶‰æß‰ºöËØùÂàóË°®ÈÄâÊã©‰∏Ä‰∏™‰ºöËØù</div>
                </div>

                <div v-else class="aicr-session-chat-right-panel">
                    <div class="aicr-session-chat-messages" role="log" aria-live="polite">
                        <div 
                            v-for="(m, idx) in sessionChatMessages" 
                            :key="`${m.timestamp || 0}_${idx}`"
                            class="aicr-session-chat-message"
                            :class="m.type === 'pet' ? 'is-pet' : 'is-user'"
                        >
                            <div class="aicr-session-chat-bubble">
                                <div class="aicr-session-chat-content md-preview-body" v-html="renderMarkdown(m.message || m.content)"></div>
                                <time class="aicr-session-chat-time" :datetime="m.timestamp">
                                    {{ formatTime(m.timestamp) }}
                                </time>
                            </div>
                        </div>
                    </div>

                    <div class="aicr-session-chat-input-container">
                        <div class="aicr-session-chat-toolbar">
                            <div class="aicr-session-chat-btn-group">
                                <button type="button" class="aicr-session-chat-btn aicr-session-chat-icon-btn" title="ÊèêÂèä" aria-label="ÊèêÂèä">
                                    @
                                </button>
                                <button type="button" class="aicr-session-chat-btn aicr-session-chat-text-btn" @click="openSessionChatContextEditor" title="È°µÈù¢‰∏ä‰∏ãÊñá" aria-label="È°µÈù¢‰∏ä‰∏ãÊñá">
                                    üìù È°µÈù¢‰∏ä‰∏ãÊñá
                                </button>
                                <button type="button" class="aicr-session-chat-btn aicr-session-chat-text-btn" title="Â∏∏ËßÅÈóÆÈ¢ò" aria-label="Â∏∏ËßÅÈóÆÈ¢ò" @click="openSessionChatFaq">
                                    üí° Â∏∏ËßÅÈóÆÈ¢ò
                                </button>
                                <button type="button" class="aicr-session-chat-btn aicr-session-chat-icon-btn" title="AI ËÆæÁΩÆ" aria-label="AI ËÆæÁΩÆ" @click="openSessionChatSettings">
                                    ‚öôÔ∏è
                                </button>
                            </div>

                            <div class="aicr-session-chat-btn-group">
                                <button
                                    type="button"
                                    class="aicr-session-chat-btn aicr-session-chat-context-switch"
                                    :class="{ active: sessionChatIncludePageContext }"
                                    @click="sessionChatIncludePageContext = !sessionChatIncludePageContext"
                                    title="‰∏ä‰∏ãÊñáÂºÄÂÖ≥"
                                    aria-label="‰∏ä‰∏ãÊñáÂºÄÂÖ≥"
                                >
                                    {{ sessionChatIncludePageContext ? '‰∏ä‰∏ãÊñá: ÂºÄ' : '‰∏ä‰∏ãÊñá: ÂÖ≥' }}
                                </button>
                                <button type="button" class="aicr-session-chat-btn aicr-session-chat-status-btn" disabled title="ËØ∑Ê±ÇÁä∂ÊÄÅÔºöÁ©∫Èó≤" aria-label="ËØ∑Ê±ÇÁä∂ÊÄÅ">
                                    ‚èπÔ∏è
                                </button>
                                <button type="button" class="aicr-session-chat-btn aicr-session-chat-clear-btn" title="Ê∏ÖÈô§ËæìÂÖ•" aria-label="Ê∏ÖÈô§ËæìÂÖ•" @click="sessionChatInputText = ''">
                                    üßπ Ê∏ÖÈô§ËæìÂÖ•
                                </button>
                            </div>
                        </div>

                        <div class="aicr-session-chat-input-wrapper">
                            <textarea
                                class="aicr-session-chat-textarea"
                                :value="sessionChatInputText"
                                @input="sessionChatInputText = $event.target.value"
                                @keydown="onSessionChatKeydown"
                                placeholder="ËæìÂÖ•Ê∂àÊÅØ... (Enter ÂèëÈÄÅ, Shift+Enter Êç¢Ë°å)"
                                rows="2"
                                aria-label="‰ºöËØùËæìÂÖ•Ê°Ü"
                            ></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-else>
            <!-- ËØÑËÆ∫ÂàóË°® -->
            <div v-if="renderComments && renderComments.length > 0" class="comment-list" role="list">
                <!-- Ë∞ÉËØï‰ø°ÊÅØ -->
                <div v-if="false" class="debug-info" style="background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; font-size: 12px;">
                    <p>Ë∞ÉËØï‰ø°ÊÅØ:</p>
                    <p>ËØÑËÆ∫Êï∞Èáè: {{ renderComments.length }}</p>
                    <p>Êñá‰ª∂‰ø°ÊÅØ: {{ file ? file.name : 'Êó†Êñá‰ª∂' }}</p>
                    <p>Âä†ËΩΩÁä∂ÊÄÅ: {{ loading }}</p>
                    <p>ÈîôËØØ‰ø°ÊÅØ: {{ error }}</p>
                </div>
                <article 
                    v-for="comment in renderComments" 
                    :key="comment.key"
                    class="comment-item"
                    :class="getCommentStatusClass(comment.status)"
                    role="listitem"
                >
                    <!-- ËØÑËÆ∫Â§¥ÈÉ® -->
                    <div class="comment-header-section">
                        <div class="comment-meta">
                            <div class="comment-author-info">
                                <div class="comment-avatar" :style="getAuthorAvatar(comment.author)">
                                    {{ getAuthorAvatar(comment.author).text }}
                                </div>
                                <div class="comment-author-details">
                                    <span class="comment-author">{{ comment.author }}</span>
                                    <time class="comment-time" :datetime="comment.timestamp">
                                        {{ formatTime(comment.timestamp) }}
                                    </time>
                                </div>
                            </div>
                            
                            <!-- ËØÑËÆ∫Á±ªÂûãÂíåÁä∂ÊÄÅ -->
                            <div class="comment-badges">
                                <span v-if="comment.type" class="comment-type" :class="`type-${comment.type}`">
                                    <i :class="getCommentTypeIcon(comment.type)"></i>
                                    {{ getCommentTypeLabel(comment.type) }}
                                </span>
                                <span v-if="comment.status" class="comment-status" :class="`status-${comment.status}`">
                                    <i :class="getCommentStatusIcon(comment.status)"></i>
                                    {{ getCommentStatusLabel(comment.status) }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- ËØÑËÆ∫ÂÜÖÂÆπ -->
                    <div class="comment-body">
                        <div v-if="comment.text" class="comment-quote">
                            <div class="quote-header">
                                <i class="fas fa-quote-left"></i>
                                <span>ÂºïÁî®‰ª£Á†Å</span>
                            </div>
                            <pre class="quote-code">{{ comment.text }}</pre>
                        </div>
                        <!-- ËØÑËÆ∫ÂÜÖÂÆπÂ±ïÁ§∫ -->
                        <div class="comment-content md-preview-body" v-html="renderMarkdown(comment.content)"></div>
                        
                        <!-- ÊîπËøõ‰ª£Á†ÅÂ±ïÁ§∫Âå∫ÂüüÔºå‰ªÖÂΩìÊúâÊîπËøõ‰ª£Á†ÅÊó∂ÊòæÁ§∫ -->
                        <div v-if="comment.improvementText" class="comment-improvement">
                            <div class="improvement-header">
                                <i class="fas fa-magic"></i>
                                <span>ÊîπËøõ‰ª£Á†Å</span>
                            </div>
                            <pre class="improvement-code">{{ comment.improvementText }}</pre>
                        </div>
                        
                        <!-- ËØÑËÆ∫Êìç‰Ωú -->
                        <div class="comment-actions">
                            <button 
                                type="button"
                                v-if="comment.status === 'pending'"
                                @click="resolveComment(comment.key)"
                                class="action-button resolve-button"
                                title="Ê†áËÆ∞‰∏∫Â∑≤Ëß£ÂÜ≥"
                            >
                                <i class="fas fa-check"></i>
                                Ëß£ÂÜ≥
                            </button>
                            
                            <button 
                                type="button"
                                v-if="comment.status === 'resolved'"
                                @click="reopenComment(comment.key)"
                                class="action-button reopen-button"
                                title="ÈáçÊñ∞ÊâìÂºÄ"
                            >
                                <i class="fas fa-undo"></i>
                                ÈáçÂºÄ
                            </button>
                            
                            <button 
                                type="button"
                                v-if="comment.author === 'ÊâãÂä®ËØÑËÆ∫'"
                                @click="openCommentEditor(comment)"
                                class="action-button resolve-button"
                                title="ÁºñËæëËØÑËÆ∫"
                            >
                                <i class="fas fa-edit"></i>
                                ÁºñËæë
                            </button>
                            
                            <button 
                                type="button"
                                @click="deleteComment(comment.key)"
                                class="action-button resolve-button"
                                :class="{ 'deleting': deletingComments[comment.key] }"
                                :disabled="deletingComments[comment.key]"
                                title="Âà†Èô§ËØÑËÆ∫"
                                :aria-label="`Âà†Èô§ËØÑËÆ∫ ${comment.author}`"
                            >
                                <i class="fas" :class="deletingComments[comment.key] ? 'fa-spinner fa-spin' : 'fa-trash'"></i>
                                <span v-if="!deletingComments[comment.key]">Âà†Èô§</span>
                                <span v-else>Âà†Èô§‰∏≠...</span>
                            </button>
                        </div>
                    </div>
                </article>
            </div>
            
            <!-- Âä†ËΩΩÁä∂ÊÄÅ - ‰ºòÂÖàÊòæÁ§∫ -->
            <div v-if="commentsLoading" class="loading-container" role="status" aria-live="polite">
                <div class="loading-spinner" aria-hidden="true"></div>
                <div class="loading-text">Ê≠£Âú®Âä†ËΩΩËØÑËÆ∫...</div>
            </div>
            
            <!-- Êú™ÈÄâ‰∏≠Êñá‰ª∂Áä∂ÊÄÅ -->
            <div v-else-if="!file && (!renderComments || renderComments.length === 0)" class="no-file-state" role="status">
                <div class="no-file-icon" aria-hidden="true">
                    <i class="fas fa-file-alt"></i>
                </div>
                <div class="no-file-title">Êú™ÈÄâ‰∏≠Êñá‰ª∂</div>
                <div class="no-file-subtitle">ËØ∑‰ªéÂ∑¶‰æßÊñá‰ª∂Ê†ë‰∏≠ÈÄâÊã©‰∏Ä‰∏™Êñá‰ª∂Êù•Êü•ÁúãËØÑËÆ∫</div>
            </div>
            
            <!-- Êó†ËØÑËÆ∫Áä∂ÊÄÅ -->
            <div v-else-if="file && (!renderComments || renderComments.length === 0)" class="no-comments-state" role="status">
                <div class="no-comments-icon" aria-hidden="true">
                    <i class="fas fa-comment-slash"></i>
                </div>
                <div class="no-comments-title">ÊöÇÊó†ËØÑËÆ∫</div>
                <div class="no-comments-subtitle">ÂºÄÂßã‰ª£Á†ÅËØÑÂÆ°ÔºåÊ∑ªÂä†Á¨¨‰∏Ä‰∏™ËØÑËÆ∫</div>
            </div>
        </div>
    </div>

    <!-- ‰ºöËØùÈ°µÈù¢‰∏ä‰∏ãÊñáÁºñËæëÂô® -->
    <div v-if="sessionChatShowContextEditor" class="session-context-modal" @click="closeSessionChatContextEditor">
        <div class="session-context-modal-content" @click.stop>
            <div class="session-context-modal-header">
                <div class="session-context-modal-title">È°µÈù¢‰∏ä‰∏ãÊñá</div>
                <div class="session-context-modal-actions">
                    <div class="session-context-mode-toggle" role="tablist" aria-label="È°µÈù¢‰∏ä‰∏ãÊñáËßÜÂõæÂàáÊç¢">
                        <button type="button" class="session-context-mode-btn" :class="{ active: sessionChatContextEditMode === 'edit' }" @click="toggleSessionChatContextEditMode('edit')" role="tab" :aria-selected="sessionChatContextEditMode === 'edit'">ÁºñËæë</button>
                        <button type="button" class="session-context-mode-btn" :class="{ active: sessionChatContextEditMode === 'preview' }" @click="toggleSessionChatContextEditMode('preview')" role="tab" :aria-selected="sessionChatContextEditMode === 'preview'">È¢ÑËßà</button>
                    </div>
                    <button type="button" class="session-context-close-btn" @click="closeSessionChatContextEditor" aria-label="ÂÖ≥Èó≠" title="ÂÖ≥Èó≠">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="session-context-modal-body">
                <textarea
                    v-if="sessionChatContextEditMode === 'edit'"
                    class="session-context-textarea"
                    v-model="sessionChatEditingPageContent"
                    rows="14"
                    aria-label="È°µÈù¢‰∏ä‰∏ãÊñáÁºñËæëÊ°Ü"
                ></textarea>
                <div v-else class="session-context-preview md-preview-body" v-html="renderMarkdown(sessionChatEditingPageContent)"></div>
            </div>
            <div class="session-context-modal-footer">
                <button type="button" class="session-context-save-btn" :disabled="sessionChatSavingContext" @click="saveSessionChatPageContext" aria-label="‰øùÂ≠ò">
                    ‰øùÂ≠ò
                </button>
                <button type="button" class="session-context-cancel-btn" @click="closeSessionChatContextEditor" aria-label="ÂèñÊ∂à">
                    ÂèñÊ∂à
                </button>
            </div>
        </div>
    </div>

    <!-- ËØÑËÆ∫ÁºñËæëÊ®°ÊÄÅÊ°Ü -->
    <div v-if="showCommentEditor" class="comment-editor-modal" @click="closeCommentEditor">
        <div class="comment-editor-content" @click.stop>
            <div class="editor-header">
                <h3 class="editor-title">ÁºñËæëËØÑËÆ∫</h3>
                <button type="button" @click="closeCommentEditor" class="close-btn" title="ÂÖ≥Èó≠">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="editor-body">
                <div class="comment-edit-form">
                    <!-- ËØÑËÆ∫‰ø°ÊÅØÁºñËæë -->
                    <div class="form-row">
                        <div class="form-group half-width">
                            <label>ËØÑËÆ∫ËÄÖ:</label>
                            <input 
                                v-model="editingCommentAuthor"
                                type="text" 
                                class="form-input"
                                placeholder="ËæìÂÖ•ËØÑËÆ∫ËÄÖÂßìÂêç"
                            />
                        </div>
                        <div class="form-group half-width">
                            <label>Êó∂Èó¥:</label>
                            <input 
                                v-model="editingCommentTimestamp"
                                type="datetime-local" 
                                class="form-input"
                                aria-label="ËØÑËÆ∫Êó∂Èó¥"
                            />
                        </div>
                    </div>
                    
                    <!-- ÂºïÁî®‰ª£Á†ÅÁºñËæë -->
                    <div class="form-group">
                        <label>ÂºïÁî®‰ª£Á†Å:</label>
                        <textarea 
                            v-model="editingCommentText"
                            class="form-textarea quoted-code-textarea"
                            placeholder="ËæìÂÖ•ÂºïÁî®ÁöÑ‰ª£Á†ÅÔºàÂèØÈÄâÔºâ"
                            rows="12"
                        ></textarea>
                    </div>
                    
                    <!-- ËØÑËÆ∫ÂÜÖÂÆπÁºñËæë -->
                    <div class="form-group">
                        <label>ËØÑËÆ∫ÂÜÖÂÆπ:</label>
                        <textarea 
                            v-model="editingCommentContent"
                            class="form-textarea comment-content-textarea"
                            placeholder="ÁºñËæëËØÑËÆ∫ÂÜÖÂÆπÔºàÊîØÊåÅMarkdownÔºâ"
                            rows="12"
                            @keydown="onCommentEditKeydown"
                        ></textarea>
                        <div class="textarea-hint">
                            <i class="fas fa-info-circle"></i>
                            ÊîØÊåÅMarkdownÊ†ºÂºèÔºåCtrl/Cmd + Enter ‰øùÂ≠òÔºåEsc ÂèñÊ∂à
                        </div>
                    </div>
                    
                    <!-- ÊîπËøõ‰ª£Á†ÅÁºñËæë -->
                    <div class="form-group">
                        <label>ÊîπËøõ‰ª£Á†Å (ÂèØÈÄâ):</label>
                        <textarea 
                            v-model="editingImprovementText"
                            class="form-textarea improvement-textarea"
                            placeholder="ËæìÂÖ•ÊîπËøõÂêéÁöÑ‰ª£Á†ÅÔºàÂèØÈÄâÔºâ"
                            rows="12"
                        ></textarea>
                    </div>
                    
                    <!-- ËØÑËÆ∫Á±ªÂûãÂíåÁä∂ÊÄÅ -->
                    <div class="form-row">
                        <div class="form-group half-width">
                            <label>ËØÑËÆ∫Á±ªÂûã:</label>
                            <select v-model="editingCommentType" class="form-select" aria-label="ËØÑËÆ∫Á±ªÂûã">
                                <option value="">Êó†Á±ªÂûã</option>
                                <option value="suggestion">Âª∫ËÆÆ</option>
                                <option value="question">ÈóÆÈ¢ò</option>
                                <option value="bug">ÈîôËØØ</option>
                                <option value="discussion">ËÆ®ËÆ∫</option>
                                <option value="praise">Ë°®Êâ¨</option>
                                <option value="nitpick">ÁªÜËäÇ</option>
                            </select>
                        </div>
                        <div class="form-group half-width">
                            <label>Áä∂ÊÄÅ:</label>
                            <select v-model="editingCommentStatus" class="form-select" aria-label="ËØÑËÆ∫Áä∂ÊÄÅ">
                                <option value="pending">ÂæÖÂ§ÑÁêÜ</option>
                                <option value="resolved">Â∑≤Ëß£ÂÜ≥</option>
                                <option value="closed">Â∑≤ÂÖ≥Èó≠</option>
                                <option value="wontfix">‰∏ç‰øÆÂ§ç</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button 
                            type="button"
                            @click="saveEditedComment"
                                class="save-btn"
                                :disabled="editingSaving"
                        >
                            <i class="fas fa-save"></i>
                            ‰øùÂ≠ò
                        </button>
                        <button type="button" @click="closeCommentEditor" class="cancel-btn">
                            <i class="fas fa-times"></i>
                            ÂèñÊ∂à
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Âà†Èô§Á°ÆËÆ§ÂØπËØùÊ°Ü -->
    <div v-if="showDeleteDialog" class="delete-confirmation-dialog show" role="dialog" aria-labelledby="delete-dialog-title" aria-modal="true">
        <div class="dialog-overlay" @click="cancelDelete"></div>
        <div class="dialog-content">
            <div class="dialog-header">
                <i class="fas fa-exclamation-triangle"></i>
                <h3 id="delete-dialog-title">Á°ÆËÆ§Âà†Èô§ËØÑËÆ∫</h3>
            </div>
            <div class="dialog-body">
                <p>Á°ÆÂÆöË¶ÅÂà†Èô§ <strong>{{ deleteTargetAuthor }}</strong> ÁöÑËØÑËÆ∫ÂêóÔºü</p>
                <p class="warning-text">Ê≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºåËØ∑Ë∞®ÊÖéÊìç‰Ωú„ÄÇ</p>
            </div>
            <div class="dialog-actions">
                <button class="btn-cancel" @click="cancelDelete" aria-label="ÂèñÊ∂àÂà†Èô§">ÂèñÊ∂à</button>
                <button class="btn-confirm" @click="confirmDelete" aria-label="Á°ÆËÆ§Âà†Èô§">Á°ÆËÆ§Âà†Èô§</button>
            </div>
        </div>
    </div>
</aside>
