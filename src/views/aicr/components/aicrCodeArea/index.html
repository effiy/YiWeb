<section class="aicr-code" :class="{ 'with-sidebar-collapsed': sidebarCollapsed, 'with-chat-collapsed': chatPanelCollapsed }"
    aria-label="‰ª£Á†ÅÂå∫">
    <button type="button" class="chat-expand-handle" v-show="chatPanelCollapsed"
        @click="toggleChatPanel" aria-label="Â±ïÂºÄËÅäÂ§©Èù¢Êùø" title="Â±ïÂºÄËÅäÂ§©Èù¢Êùø">
        <i class="fas fa-chevron-left" aria-hidden="true"></i>
        <span class="label">ËÅäÂ§©</span>
    </button>

    <button type="button" class="chat-panel-toggle" v-show="!chatPanelCollapsed"
        @click="toggleChatPanel" title="Êî∂Ëµ∑ËÅäÂ§©Èù¢Êùø" aria-label="Êî∂Ëµ∑ËÅäÂ§©Èù¢Êùø"
        :style="{ right: ((chatPanelWidth || 420) - 14) + 'px', left: 'auto' }">
        <i class="fas fa-chevron-right" aria-hidden="true"></i>
    </button>

    <div class="aicr-code-layout is-tree">
        <div class="aicr-code-main">
            <code-view :file="currentFile" :loading="loading" :error="errorMessage" @create-session="handleSessionCreate"></code-view>
        </div>

        <div class="aicr-code-chat"
            v-show="!chatPanelCollapsed"
            :style="{ '--aicr-chat-width': (chatPanelWidth || 420) + 'px' }">
            <div class="pet-chat-right-panel" aria-label="‰ºöËØùËÅäÂ§©Èù¢Êùø">
                <div class="pet-chat-messages" id="pet-chat-messages" role="log" aria-live="polite">
                    <base-loading
                        v-if="activeSessionLoading"
                        container-class="pet-chat-loading"
                        text="Ê≠£Âú®Âä†ËΩΩ‰ºöËØù..."
                    ></base-loading>
                    <div v-else-if="activeSessionError" class="pet-chat-error" role="alert" aria-live="polite">
                        <div class="error-text">{{ activeSessionError }}</div>
                    </div>
                    <base-empty-state
                        v-else-if="!activeSession"
                        wrapper-class="pet-chat-empty"
                        card-class="pet-chat-empty-card"
                        sr-text="Êú™ÈÄâÊã©‰ºöËØùÔºå‰ªéÂ∑¶‰æß‰ºöËØùÂàóË°®ÈÄâÊã©‰∏Ä‰∏™‰ºöËØùÂºÄÂßãËÅäÂ§©"
                        title="Êú™ÈÄâÊã©‰ºöËØù"
                        subtitle="‰ªéÂ∑¶‰æß‰ºöËØùÂàóË°®ÈÄâÊã©‰∏Ä‰∏™‰ºöËØùÂºÄÂßãËÅäÂ§©"
                        hint="‰πüÂèØ‰ª•Âú®Â∑¶‰æßÊêúÁ¥¢Ê°ÜËæìÂÖ•ÂÖ≥ÈîÆËØçÂø´ÈÄüÂÆö‰Ωç"
                        title-class="pet-chat-empty-title"
                        subtitle-class="pet-chat-empty-subtitle"
                        hint-class="pet-chat-empty-hint"
                    >
                        <template #icon>
                            <div class="pet-chat-empty-icon" aria-hidden="true">
                                <i class="fas fa-inbox"></i>
                            </div>
                        </template>
                    </base-empty-state>
                    <div v-else style="width: 100%;">
                        <div v-if="activeSession" class="pet-chat-message is-pet" data-welcome-message="true" v-html="buildWelcomeCardHtmlForSession(activeSession)" ref="welcomeCardRef"></div>
                        
                        <div v-for="(m, idx) in sessionChatMessages(activeSession)"
                            :key="`${m.timestamp || 0}_${idx}`" class="pet-chat-message" :class="{
                                'is-pet': m.type === 'pet',
                                'is-user': m.type !== 'pet',
                                'is-error': !!m.error,
                                'is-aborted': !!m.aborted,
                                'is-streaming': isSessionChatStreamingMessage(m, idx)
                            }" :data-chat-idx="idx" :data-chat-timestamp="m.timestamp || 0"
                            :data-chat-type="m.type === 'pet' ? 'pet' : 'user'">
                            <div class="pet-chat-bubble">
                                <div v-if="Array.isArray(m.imageDataUrls) && m.imageDataUrls.length > 0"
                                    class="pet-chat-images">
                                    <img v-for="(src, imgIdx) in m.imageDataUrls"
                                        :key="`${m.timestamp || 0}_${imgIdx}`" class="pet-chat-image" :src="src"
                                        alt="ÂõæÁâáÊ∂àÊÅØ" />
                                </div>
                                <img v-else-if="m.imageDataUrl" class="pet-chat-image" :src="m.imageDataUrl"
                                    alt="ÂõæÁâáÊ∂àÊÅØ" />
                                <div v-if="m.type === 'pet' && (!(m.message || m.content) || !String(m.message || m.content).trim()) && sessionChatSending && idx === (sessionChatMessages(activeSession).length - 1)"
                                    class="pet-chat-typing" aria-label="ÁîüÊàê‰∏≠">...</div>
                                <markdown-view v-else-if="(m.message || m.content) && String(m.message || m.content).trim() && isSessionChatStreamingMessage(m, idx)"
                                    class="pet-chat-content md-preview-body pet-chat-content-streaming"
                                    mode="streaming"
                                    :content="m.message || m.content"></markdown-view>
                                <markdown-view v-else-if="(m.message || m.content) && String(m.message || m.content).trim()"
                                    class="pet-chat-content md-preview-body"
                                    mode="markdown"
                                    :content="m.message || m.content"></markdown-view>
                                <div class="pet-chat-meta">
                                    <div class="pet-chat-meta-actions">
                                        <button
                                            v-if="(m.message || m.content) && String(m.message || m.content).trim()"
                                            type="button" class="pet-chat-meta-btn"
                                            @click="copySessionChatMessage(m.message || m.content, m, idx)"
                                            aria-label="Â§çÂà∂Ê∂àÊÅØ" title="Â§çÂà∂">{{ sessionChatCopyButtonLabel(m, idx)
                                            }}</button>
                                        <template
                                            v-if="Array.isArray(weChatRobots) && weChatRobots.length > 0 && m.type === 'pet' && (m.message || m.content) && String(m.message || m.content).trim()">
                                            <button v-for="(bot, bi) in weChatRobots" :key="bot.id || ('wrb_' + bi)"
                                                type="button" class="pet-chat-meta-btn"
                                                :title="'ÂèëÈÄÅÂà∞Ôºö' + (bot.name || 'Êú∫Âô®‰∫∫')"
                                                :aria-label="'ÂèëÈÄÅÂà∞Êú∫Âô®‰∫∫Ôºö' + (bot.name || 'Êú∫Âô®‰∫∫')"
                                                @click="sendSessionChatMessageToRobot(bot, m, idx)">{{ bot.name ||
                                                'Êú∫Âô®‰∫∫' }}</button>
                                        </template>
                                        <button type="button" class="pet-chat-meta-btn"
                                            :disabled="sessionChatSending" @click="editSessionChatMessageAt(idx)"
                                            aria-label="ÁºñËæëÊ∂àÊÅØ" title="ÁºñËæë">‚úèÔ∏è</button>
                                        <button v-if="m.type !== 'pet'" type="button" class="pet-chat-meta-btn"
                                            :disabled="sessionChatSending" @click="resendSessionChatMessageAt(idx)"
                                            aria-label="ÈáçÊñ∞ÂèëÈÄÅ" title="ÈáçÊñ∞ÂèëÈÄÅ">üì®</button>
                                        <button type="button" class="pet-chat-meta-btn"
                                            @click="moveSessionChatMessageUp(idx)" aria-label="‰∏äÁßªÊ∂àÊÅØ"
                                            title="‰∏äÁßª">‚¨ÜÔ∏è</button>
                                        <button type="button" class="pet-chat-meta-btn"
                                            @click="moveSessionChatMessageDown(idx)" aria-label="‰∏ãÁßªÊ∂àÊÅØ"
                                            title="‰∏ãÁßª">‚¨áÔ∏è</button>
                                        <button
                                            v-if="m.type === 'pet' && canRegenerateSessionChatMessage(activeSession, idx)"
                                            type="button" class="pet-chat-meta-btn"
                                            :disabled="sessionChatSending || isSessionChatRegenerating(m, idx)"
                                            @click="regenerateSessionChatMessageAt(idx)" aria-label="ÈáçÊñ∞ÁîüÊàêÂõûÂ§ç"
                                            title="ÈáçÊñ∞ÁîüÊàê">{{ sessionChatRegenerateButtonLabel(m, idx) }}</button>
                                        <button type="button" class="pet-chat-meta-btn"
                                            :disabled="sessionChatSending" @click="deleteSessionChatMessageAt(idx)"
                                            aria-label="Âà†Èô§Ê∂àÊÅØ" title="Âà†Èô§">üóëÔ∏è</button>
                                    </div>
                                    <time class="pet-chat-time" :datetime="m.timestamp">{{ formatTime(m.timestamp)
                                        }}</time>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="pet-chat-input-container chat-input-container">
                    <div class="pet-chat-toolbar chat-input-toolbar">
                        <div class="pet-chat-toolbar-left chat-input-btn-group">
                            <button type="button" class="pet-chat-btn chat-input-btn chat-input-text-btn"
                                @click="openSessionContextEditor" title="È°µÈù¢‰∏ä‰∏ãÊñá" aria-label="È°µÈù¢‰∏ä‰∏ãÊñá">üìù</button>
                            <button type="button" class="pet-chat-btn chat-input-btn chat-input-text-btn"
                                :disabled="!activeSession" @click="activeSession && handleSessionEdit(activeSession.key)"
                                title="ÁºñËæëÊ†áÈ¢ò" aria-label="ÁºñËæëÊ†áÈ¢ò">‚úèÔ∏è</button>
                            <button type="button" class="pet-chat-btn chat-input-btn chat-input-text-btn"
                                :disabled="!activeSession" @click="activeSession && handleSessionTag(activeSession.key)"
                                title="ÁÆ°ÁêÜÊ†áÁ≠æ" aria-label="ÁÆ°ÁêÜÊ†áÁ≠æ">üè∑Ô∏è</button>
                            <button type="button" class="pet-chat-btn chat-input-btn chat-input-text-btn"
                                @click="openSessionFaq" title="Â∏∏ËßÅÈóÆÈ¢ò" aria-label="Â∏∏ËßÅÈóÆÈ¢ò">üí°</button>
                            <button type="button" class="pet-chat-btn chat-input-btn chat-input-text-btn"
                                @click="openWeChatSettings" title="ÂæÆ‰ø°Êú∫Âô®‰∫∫ËÆæÁΩÆ" aria-label="ÂæÆ‰ø°Êú∫Âô®‰∫∫ËÆæÁΩÆ">ü§ñ</button>
                            <button type="button" class="pet-chat-btn chat-input-btn chat-input-text-btn"
                                @click="openSessionChatImagePicker" title="‰∏ä‰º†ÂõæÁâá" aria-label="‰∏ä‰º†ÂõæÁâá">üñºÔ∏è</button>
                            <input id="pet-chat-image-input" type="file" accept="image/*" multiple
                                style="display:none" @change="onSessionChatImageInputChange" />
                        </div>
                        <div class="pet-chat-toolbar-right chat-input-btn-group">
                            <div class="context-switch-container" :class="{ active: sessionContextEnabled }"
                                title="ÂºÄÂêØ/ÂÖ≥Èó≠È°µÈù¢‰∏ä‰∏ãÊñá">
                                <span class="context-switch-label">È°µÈù¢‰∏ä‰∏ãÊñá</span>
                                <label class="context-switch-wrapper" for="context-switch">
                                    <div class="context-switch-thumb"></div>
                                </label>
                                <input id="context-switch" class="context-switch-input" type="checkbox"
                                    :checked="sessionContextEnabled"
                                    @change="setSessionContextEnabled($event.target.checked)"
                                    aria-label="È°µÈù¢‰∏ä‰∏ãÊñáÂºÄÂÖ≥" />
                            </div>
                            <button type="button" class="chat-input-status-btn"
                                :class="{ active: sessionChatSending }" :disabled="!sessionChatSending"
                                @click="abortSessionChatRequest"
                                :title="sessionChatSending ? 'ËØ∑Ê±ÇÁä∂ÊÄÅÔºöÁîüÊàê‰∏≠ÔºàÁÇπÂáªÂÅúÊ≠¢Ôºâ' : 'ËØ∑Ê±ÇÁä∂ÊÄÅÔºöÁ©∫Èó≤'" aria-label="ËØ∑Ê±ÇÁä∂ÊÄÅ">{{
                                sessionChatSending ? '‚è∏Ô∏è' : '‚èπÔ∏è' }}</button>
                        </div>
                    </div>

                    <div class="chat-input-wrapper">
                        <div v-if="Array.isArray(sessionChatDraftImages) && sessionChatDraftImages.length > 0"
                            class="pet-chat-draft-images" aria-label="ÂæÖÂèëÈÄÅÂõæÁâá">
                            <div v-for="(src, imgIdx) in sessionChatDraftImages" :key="`draft_${imgIdx}`"
                                class="pet-chat-draft-image">
                                <img class="pet-chat-draft-image-preview" :src="src" alt="ÂæÖÂèëÈÄÅÂõæÁâá" />
                                <button type="button" class="pet-chat-draft-image-remove"
                                    @click="removeSessionChatDraftImage(imgIdx)" aria-label="ÁßªÈô§ÂõæÁâá"
                                    title="ÁßªÈô§">‚úï</button>
                            </div>
                            <button type="button" class="pet-chat-draft-images-clear"
                                @click="clearSessionChatDraftImages" aria-label="Ê∏ÖÁ©∫ÂõæÁâá" title="Ê∏ÖÁ©∫ÂõæÁâá">Ê∏ÖÁ©∫ÂõæÁâá</button>
                        </div>

                        <div class="pet-chat-input-row">
                            <textarea id="pet-chat-input" class="pet-chat-textarea chat-message-input"
                                :value="sessionChatInput" @input="onSessionChatInput"
                                @keydown="onSessionChatKeydown" @compositionstart="onSessionChatCompositionStart"
                                @compositionupdate="onSessionChatCompositionUpdate"
                                @compositionend="onSessionChatCompositionEnd" @paste="onSessionChatPaste"
                                placeholder="ËæìÂÖ•Ê∂àÊÅØ... (Enter ÂèëÈÄÅ, Shift+Enter Êç¢Ë°å)" rows="2"
                                aria-label="‰ºöËØùËæìÂÖ•Ê°Ü"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <aicr-modals></aicr-modals>
</section>
