<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YiWeb</title>
    <link rel="stylesheet" href="../../views/aicr/index.css">
    <link rel="stylesheet" href="../../libs/font-awesome/css/all.min.css">
    <script src="../../libs/vue/vue.global.js"></script>
    <!-- Marked.js for Markdown rendering -->
    <script src="../../libs/marked/marked.min.js"></script>
    <!-- Mermaid.js for diagram rendering -->
    <script src="../../libs/mermaid/mermaid.min.js"></script>
    <!-- Styles moved to index.css -->
</head>
<body>
    <div id="app" class="aicr-code-page">
        
        <!-- 主要内容区域 -->
        <main class="aicr-code-main">
            <div class="aicr-code-content">
                <!-- 代码查看器 -->
                <div class="aicr-code-viewer">
                    <div v-if="loading" class="aicr-code-loading">
                        <div class="loading-spinner" aria-hidden="true"></div>
                        <div>正在加载代码...</div>
                    </div>
                    <div v-else-if="error" class="aicr-code-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>{{ error }}</div>
                    </div>
                    <div v-else-if="currentFile" class="code-content">
                        <code-view 
                            :file="currentFile" 
                            :loading="loading" 
                            :error="error"
                            :comments="currentComments"
                            :project-id="fileInfo.project"
                            :version-id="fileInfo.version"
                            :hide-jump-button="true"
                            @comment-delete="handleCommentDelete"
                            @comment-resolve="handleCommentResolve"
                            @comment-reopen="handleCommentReopen"
                            @reload-comments="handleReloadComments"
                            @file-saved="handleFileSaved"
                        ></code-view>
                    </div>
                    <div v-else class="aicr-code-empty">
                        <i class="fas fa-file-code"></i>
                        <div>未找到文件</div>
                    </div>
                </div>
                
                <!-- 评论区 -->
                <aside class="aicr-code-comments" :class="{ show: showComments }">
                    <div class="aicr-code-comments-content">
                        <comment-panel 
                            :comments="currentComments" 
                            :file="currentFile"
                            :new-comment="newComment" 
                            :loading="loading" 
                            :error="error" 
                            :collapsed="!showComments"
                            :project-id="fileInfo.project"
                            :version-id="fileInfo.version"
                            :commenters="commenters"
                            :selected-commenter-ids="selectedCommenterIds"
                            :commenters-loading="commentersLoading"
                            :commenters-error="commentersError"
                            @comment-submit="handleCommentSubmit" 
                            @comment-input="handleCommentInput"
                            @commenter-select="handleCommenterSelect"
                            @comment-delete="handleCommentDelete"
                            @comment-resolve="handleCommentResolve"
                            @comment-reopen="handleCommentReopen"
                            @toggle-collapse="toggleComments"
                        ></comment-panel>
                    </div>
                </aside>
                
                <!-- 评论区收起后的展开按钮 -->
                <button 
                    type="button"
                    class="aicr-code-comments-expand-btn" 
                    v-show="!showComments"
                    @click="toggleComments"
                    aria-label="展开评论区"
                    title="展开评论区">
                </button>
            </div>
        </main>
    </div>

    <!-- 全局加载指示器 -->
    <section id="global-loading-indicator" class="loading-indicator" aria-hidden="true" aria-label="全局加载中">
        <div class="loading-content">
            <div class="loading-spinner" role="status" aria-live="polite" aria-label="正在加载"></div>
            <p class="loading-text" id="loading-text">正在加载...</p>
        </div>
    </section>

    <!-- 脚本标签 -->
    <script type="module" src="../../config.js"></script>
    <script type="module" src="../../utils/chartViewer.js"></script>
    <script type="module" src="../../utils/mermaid.js"></script>
    <script type="module" src="../../utils/mermaidDebug.js"></script>
    <script type="module" src="../../utils/mermaidRenderer.js"></script>
    <script type="module" src="../../views/aicr/components/codeView/index.js"></script>
    <script type="module" src="../../views/aicr/components/commentPanel/index.js"></script>
    <script type="module" src="../../views/aicr/aicr-code.js"></script>
    <script type="module" src="../../utils/performance.js"></script>
</body>
</html>

